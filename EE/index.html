<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Electrical | Test Record</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Print Styles - Exact Replica of Test Record Sheet */
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            body { background: white; color: black; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            #root { width: 100%; height: 100%; overflow: visible; }
            
            /* Reset sizing for print */
            .max-w-2xl { max-width: none !important; margin: 0 !important; }
            .shadow-2xl, .shadow-lg, .shadow-md { box-shadow: none !important; }
            .bg-gray-900 { background-color: white !important; }
            .text-gray-100 { color: black !important; }
            
            /* The Sheet Container */
            .print-sheet {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                font-family: Arial, Helvetica, sans-serif;
                font-size: 10px;
                line-height: 1.1;
            }
            
            /* Table Resets */
            table { border-collapse: collapse; width: 100%; table-layout: fixed; }
            th, td { border: 1px solid black; padding: 1px 2px; text-align: center; vertical-align: middle; overflow: hidden; white-space: nowrap; }
            
            /* Vertical Text Utilities */
            .vertical-text {
                writing-mode: vertical-rl;
                transform: rotate(180deg);
                white-space: nowrap;
                text-align: center;
                margin: 0 auto;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Specific Color Classes for Print */
            .bg-print-black { background-color: black !important; color: white !important; }
            .bg-print-blue { background-color: #3b82f6 !important; color: white !important; } /* Blue-500 equivalent */
            .bg-print-red { background-color: #ef4444 !important; color: white !important; } /* Red-500 equivalent */
            .bg-print-gray { background-color: #e5e7eb !important; }
            
            /* Borders */
            .border-black { border: 1px solid black !important; }
            .border-b-dotted { border-bottom: 1px dotted black !important; }
            
            /* Text Sizes */
            .text-xs { font-size: 8px !important; }
            .text-xxs { font-size: 7px !important; }
            .text-title { font-size: 24px !important; color: #991b1b !important; } /* Red-800 */
            
            /* Checkboxes in print */
            .check-box { 
                width: 10px; 
                height: 10px; 
                border: 1px solid black; 
                display: inline-flex; 
                align-items: center; 
                justify-content: center;
                margin: 0 2px;
                font-size: 8px;
                line-height: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Zap, Save, Plus, ChevronRight, AlertTriangle, CheckCircle2, 
            FileText, Home, ArrowLeft, Trash2, Activity, ShieldCheck, 
            Download, RotateCcw, Lightbulb, Printer, X, Settings, Calendar,
            Hash, User, PenTool, CheckSquare, MoreHorizontal
        } from 'https://esm.sh/lucide-react@0.294.0';

        // --- CONSTANTS ---
        const CABLE_TYPES = ["PVC", "SWA", "Singles", "FP200", "NYM-J"];
        const CIRCUIT_TYPES = [
            { id: 'socket', label: 'Socket Outlets (Radial)' },
            { id: 'ring', label: 'Socket Outlets (Ring)' },
            { id: 'lighting', label: 'Lighting' },
            { id: 'fixed', label: 'Fixed Appliance' },
            { id: 'ev', label: 'EV Charger' },
            { id: 'cooker', label: 'Cooker / Oven' },
            { id: 'shower', label: 'Shower' }
        ];
        const PROTECTIVE_DEVICES = [
            { id: 'mcb', label: 'MCB' },
            { id: 'rcbo', label: 'RCBO' },
            { id: 'fuse', label: 'Fuse' },
        ];
        const CURVES = ['B', 'C', 'D']; 
        const RATINGS = [6, 10, 16, 20, 25, 32, 40, 50, 63]; 
        const CSA_SIZES = ['1.5', '2.5', '4.0', '6.0', '10.0', '16.0', '25.0'];

        const getMaxZs = (rating, curve) => {
            const r = parseInt(rating) || 20;
            // Simplified BS7671 / ET101 values approximation
            if (curve === 'B') return (230 / (r * 5)).toFixed(2);
            if (curve === 'C') return (230 / (r * 10)).toFixed(2);
            if (curve === 'D') return (230 / (r * 20)).toFixed(2);
            return (230 / (r * 5)).toFixed(2); 
        };

        // --- COMPONENTS ---

        const Header = ({ view, onBack, title }) => (
            <header className="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-50 shadow-lg no-print">
                <div className="flex items-center justify-between max-w-2xl mx-auto">
                    <div className="flex items-center gap-3">
                        {view !== 'dashboard' && (
                            <button onClick={onBack} className="p-2 text-gray-400 hover:text-yellow-400 hover:bg-gray-700 rounded-full transition-colors">
                                <ArrowLeft size={24} />
                            </button>
                        )}
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-yellow-400 rounded-lg flex items-center justify-center text-gray-900 font-bold text-xl shadow-lg shadow-yellow-400/20">
                                <Zap size={24} fill="currentColor" />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-yellow-400 tracking-tight leading-none">Executive Electrical</h1>
                                <p className="text-xs text-gray-400 font-medium tracking-wide uppercase mt-0.5">{title}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
        );

        const SelectGroup = ({ label, value, onChange, options, icon: Icon }) => (
            <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-400 mb-1 flex items-center gap-2">
                    {Icon && <Icon size={14} className="text-yellow-400" />} {label}
                </label>
                <div className="relative">
                    <select 
                        value={value} 
                        onChange={(e) => onChange(e.target.value)}
                        className="w-full bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-transparent block p-3 shadow-inner appearance-none transition-all"
                    >
                        <option value="" disabled>Select {label}</option>
                        {options.map((opt, idx) => (
                            <option key={idx} value={typeof opt === 'object' ? opt.id : opt}>
                                {typeof opt === 'object' ? opt.label : opt}
                            </option>
                        ))}
                    </select>
                    <div className="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                        <ChevronRight size={16} className="rotate-90" />
                    </div>
                </div>
            </div>
        );

        const InputField = ({ label, value, onChange, placeholder, type = "text", icon: Icon, step, min, max }) => (
             <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-400 mb-1 flex items-center gap-2">
                    {Icon && <Icon size={14} className="text-yellow-400" />} {label}
                </label>
                <input
                    type={type}
                    value={value || ''}
                    onChange={(e) => onChange(e.target.value)}
                    className={`block w-full p-3 text-base bg-gray-700 border ${value && max && parseFloat(value) > parseFloat(max) ? 'border-red-500 ring-1 ring-red-500' : 'border-gray-600'} rounded-lg shadow-inner focus:ring-2 focus:ring-yellow-400 text-white transition-all`}
                    placeholder={placeholder}
                    step={step}
                    min={min}
                    inputMode={type === 'number' ? 'decimal' : undefined}
                />
                 {value && max && parseFloat(value) > parseFloat(max) && (
                    <p className="text-red-400 text-xs mt-1 flex items-center gap-1 font-bold animate-pulse"><AlertTriangle size={12} /> Limit Exceeded (&gt; {max})</p>
                )}
            </div>
        );

        const Dashboard = ({ installation, circuits, stats, setView, createNewCircuit, handleReset }) => (
            <div className="pb-24 bg-gray-900 min-h-screen font-sans text-gray-100 no-print">
                <div className="bg-gray-800 p-6 mb-4 border-b border-gray-700 shadow-md">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h2 className="text-2xl font-bold text-white tracking-tight">{installation.clientName || 'New Job'}</h2>
                            <p className="text-sm text-gray-400 mt-1">{installation.address || 'Address not set'}</p>
                        </div>
                        <button onClick={() => setView('details')} className="text-yellow-400 text-sm font-bold border border-yellow-400/30 px-3 py-1 rounded-full hover:bg-yellow-400/10 transition-colors flex items-center gap-1">
                            <PenTool size={12} /> Edit Details
                        </button>
                    </div>
                    <div className="grid grid-cols-3 gap-3 mt-4">
                        <div className="bg-gray-700/50 p-3 rounded-xl border border-gray-600 text-center backdrop-blur-sm"><span className="block text-3xl font-bold text-blue-400">{stats.total}</span><span className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Circuits</span></div>
                        <div className="bg-gray-700/50 p-3 rounded-xl border border-gray-600 text-center backdrop-blur-sm"><span className="block text-3xl font-bold text-green-400">{stats.completed}</span><span className="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Tested</span></div>
                        <div className={`p-3 rounded-xl border text-center backdrop-blur-sm ${stats.failed > 0 ? 'bg-red-900/20 border-red-500/50' : 'bg-gray-700/50 border-gray-600'}`}><span className={`block text-3xl font-bold ${stats.failed > 0 ? 'text-red-500' : 'text-gray-400'}`}>{stats.failed}</span><span className={`text-[10px] uppercase font-bold tracking-wider ${stats.failed > 0 ? 'text-red-400' : 'text-gray-500'}`}>Failed</span></div>
                    </div>
                    <div className="mt-6 flex gap-3">
                        <button onClick={() => setView('report')} className="flex-1 flex items-center justify-center gap-2 bg-yellow-400 text-gray-900 py-3 rounded-lg text-sm font-bold hover:bg-yellow-300 transition-all shadow-lg shadow-yellow-400/10 transform hover:scale-[1.02] active:scale-[0.98]"><Printer size={16} /> View Certificate</button>
                        <button onClick={handleReset} className="flex items-center justify-center px-4 bg-gray-700 text-gray-400 rounded-lg hover:bg-red-900/30 hover:text-red-400 border border-gray-600 transition-all"><RotateCcw size={16} /></button>
                    </div>
                </div>

                <div className="px-4">
                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1 flex items-center gap-2"><Activity size={12} /> Circuit Schedule</h3>
                    {circuits.length === 0 ? (
                        <div className="text-center py-16 bg-gray-800/50 rounded-xl border-2 border-dashed border-gray-700 mx-auto max-w-sm">
                            <Zap className="h-12 w-12 text-yellow-400 mx-auto mb-2 animate-pulse opacity-50" />
                            <p className="text-gray-400 font-medium">No circuits yet.</p>
                            <p className="text-gray-500 text-xs mt-1">Tap the + button to add one</p>
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {circuits.map((circuit) => (
                                <CircuitListItem key={circuit.id} circuit={circuit} setView={setView} />
                            ))}
                        </div>
                    )}
                </div>

                <button onClick={createNewCircuit} className="fixed bottom-6 right-6 bg-yellow-400 text-gray-900 w-16 h-16 rounded-full shadow-xl shadow-yellow-400/20 flex items-center justify-center hover:bg-yellow-300 hover:scale-110 active:scale-95 transition-all z-40"><Plus size={32} strokeWidth={2.5} /></button>
            </div>
        );

        const CircuitListItem = ({ circuit, setView }) => {
            const maxZs = getMaxZs(circuit.rating, circuit.curve);
            const isFailed = circuit.zs && (parseFloat(circuit.zs) > parseFloat(maxZs));
            const isComplete = circuit.zs && circuit.riso_le;
            let statusClass = 'bg-gray-700 text-gray-400';
            if (isFailed) statusClass = 'bg-red-500/20 text-red-400 border border-red-500/50';
            else if (isComplete) statusClass = 'bg-green-500/20 text-green-400 border border-green-500/50';

            return (
                <div onClick={() => { window.setActiveCircuitId(circuit.id); setView('edit-circuit'); }} className={`p-4 rounded-xl border flex items-center justify-between cursor-pointer hover:border-yellow-400/50 transition-colors ${isFailed ? 'bg-red-900/10 border-red-900/50' : 'bg-gray-800 border-gray-700'}`}>
                    <div className="flex items-center gap-4">
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-sm shadow-inner shrink-0 ${statusClass}`}>{circuit.ref}</div>
                        <div>
                            <h4 className="font-bold text-gray-100 text-lg">{circuit.name || 'Untitled Circuit'}</h4>
                            <p className="text-xs text-gray-400 font-mono mt-0.5">{circuit.csa}mm² | {circuit.rating}A Type {circuit.curve}</p>
                            {isFailed && <p className="text-xs text-red-400 font-bold mt-1 flex items-center gap-1"><AlertTriangle size={10} /> FAILED: Zs {circuit.zs}Ω &gt; {maxZs}Ω</p>}
                        </div>
                    </div>
                    <ChevronRight className="text-gray-600" />
                </div>
            );
        };

        const DetailsEditor = ({ installation, setInstallation, setView }) => {
            const update = (field, val) => setInstallation(prev => ({...prev, [field]: val}));
            
            // Nested update for bonding checkboxes
            const updateBonding = (key, val) => setInstallation(prev => ({
                ...prev, bonding: { ...prev.bonding, [key]: val }
            }));
            
            const updateBondingNA = (key, val) => setInstallation(prev => ({
                ...prev, bonding_na: { ...prev.bonding_na, [key]: val }
            }));

            return (
                <div className="p-4 bg-gray-900 min-h-screen text-gray-100 font-sans no-print pb-24">
                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 space-y-6">
                        
                        {/* Section: Job Info */}
                        <div>
                            <h3 className="font-bold text-lg text-yellow-400 border-b border-gray-700 pb-2 mb-4 flex items-center gap-2"><FileText size={18} /> Job Identifiers</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="Record Sheet No" value={installation.recordNo} onChange={v => update('recordNo', v)} placeholder="001" />
                                <InputField label="Seal No" value={installation.sealNo} onChange={v => update('sealNo', v)} placeholder="S-1234" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="Cert No" value={installation.certNo} onChange={v => update('certNo', v)} placeholder="A1234567" />
                                <InputField label="MPRN (11 Digits)" value={installation.mprn} onChange={v => update('mprn', v)} placeholder="1001..." type="number" />
                            </div>
                        </div>

                        {/* Section: Client */}
                        <div>
                            <h3 className="font-bold text-lg text-yellow-400 border-b border-gray-700 pb-2 mb-4 flex items-center gap-2"><User size={18} /> Client & Site</h3>
                            <InputField label="Customer Name" value={installation.clientName} onChange={v => update('clientName', v)} placeholder="Full Name" icon={User} />
                            <div>
                                <label className="block text-sm font-semibold text-gray-400 mb-1 flex items-center gap-2"><Home size={14} className="text-yellow-400" /> Installation Address</label>
                                <textarea 
                                    value={installation.address} 
                                    onChange={(e) => update('address', e.target.value)} 
                                    className="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg h-24 focus:ring-2 focus:ring-yellow-400 transition-all" 
                                    placeholder="Site Address..." 
                                />
                            </div>
                            <div className="mt-4">
                                <InputField label="Dist. Board Ref" value={installation.boardRef} onChange={v => update('boardRef', v)} placeholder="DB-1" />
                            </div>
                        </div>

                        {/* Section: Specs */}
                        <div>
                            <h3 className="font-bold text-lg text-yellow-400 border-b border-gray-700 pb-2 mb-4 flex items-center gap-2"><Activity size={18} /> Technical Specs</h3>
                            <SelectGroup label="Category" value={installation.category} onChange={v => update('category', v)} options={['Domestic', 'Commercial', 'Industrial', 'Agricultural']} />
                            <SelectGroup label="Installation Type" value={installation.type || 'New'} onChange={v => update('type', v)} options={['New', 'Rewire', 'Existing', 'Addition', 'Temp Supply', 'Other']} />
                            <InputField label="Comments / Notes" value={installation.comments} onChange={v => update('comments', v)} placeholder="Specific details..." />
                        </div>

                        {/* Section: Earthing & Bonding */}
                        <div>
                            <h3 className="font-bold text-lg text-yellow-400 border-b border-gray-700 pb-2 mb-4 flex items-center gap-2"><Zap size={18} /> Earthing & Bonding</h3>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <InputField label="Ze (Ext. Loop)" value={installation.ze} onChange={v => update('ze', v)} placeholder="0.00" type="number" step="0.01" />
                            </div>
                            
                            <label className="block text-sm font-semibold text-gray-400 mb-2">Bonding Verified</label>
                            <div className="space-y-2 mb-4">
                                {['Gas', 'Water', 'Supp', 'Electrode', 'Other'].map(type => (
                                    <div key={type} className="flex items-center justify-between bg-gray-700 p-3 rounded-lg border border-gray-600">
                                        <span className="text-sm font-bold text-gray-300 w-24">{type}</span>
                                        <div className="flex gap-4">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    className="w-5 h-5 accent-yellow-400 rounded"
                                                    checked={installation.bonding?.[type] || false}
                                                    onChange={(e) => {
                                                        updateBonding(type, e.target.checked);
                                                        if(e.target.checked) updateBondingNA(type, false);
                                                    }}
                                                />
                                                <span className="text-xs text-gray-400">YES</span>
                                            </label>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    className="w-5 h-5 accent-gray-500 rounded"
                                                    checked={installation.bonding_na?.[type] || false}
                                                    onChange={(e) => {
                                                        updateBondingNA(type, e.target.checked);
                                                        if(e.target.checked) updateBonding(type, false);
                                                    }}
                                                />
                                                <span className="text-xs text-gray-400">N/A</span>
                                            </label>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="Max Rp+Re" value={installation.maxRpRe} onChange={v => update('maxRpRe', v)} placeholder="Ω" type="number" step="0.01" />
                                <InputField label="Max Re" value={installation.maxRe} onChange={v => update('maxRe', v)} placeholder="Ω" type="number" step="0.01" />
                            </div>
                        </div>

                        {/* Section: Instruments */}
                        <div>
                            <h3 className="font-bold text-lg text-yellow-400 border-b border-gray-700 pb-2 mb-4 flex items-center gap-2"><Settings size={18} /> Test Instruments</h3>
                            <div className="bg-gray-700/50 p-4 rounded-xl border border-gray-600 mb-4">
                                <p className="text-xs text-gray-400 mb-2 uppercase font-bold">Multifunction / All Tests</p>
                                <div className="grid grid-cols-2 gap-4">
                                    <InputField label="Serial No" value={installation.testerSerial} onChange={v => update('testerSerial', v)} placeholder="SN-123" />
                                    <InputField label="Expiry Date" value={installation.testerExpiry} onChange={v => update('testerExpiry', v)} type="date" icon={Calendar} />
                                </div>
                            </div>
                        </div>

                        {/* Section: Signatures */}
                        <div>
                            <h3 className="font-bold text-lg text-yellow-400 border-b border-gray-700 pb-2 mb-4 flex items-center gap-2"><PenTool size={18} /> Sign Off</h3>
                            <InputField label="Engineer Name" value={installation.engineerName} onChange={v => update('engineerName', v)} placeholder="Your Name" />
                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="QC No" value={installation.qcNo} onChange={v => update('qcNo', v)} placeholder="QC-..." />
                                <InputField label="Reg No" value={installation.regNo} onChange={v => update('regNo', v)} placeholder="Reg-..." />
                            </div>
                            <InputField label="Test Date" value={installation.testDate} onChange={v => update('testDate', v)} type="date" icon={Calendar} />
                        </div>

                        <button onClick={() => setView('dashboard')} className="w-full bg-yellow-400 text-gray-900 font-bold py-4 rounded-xl mt-4 hover:bg-yellow-300 shadow-lg shadow-yellow-400/20 text-lg transition-transform active:scale-[0.98]">Save Details & Return</button>
                    </div>
                </div>
            );
        };

        const CircuitEditor = ({ activeCircuit, setCircuits, setView }) => {
            const [tab, setTab] = useState('wiring');
            const [localCircuit, setLocalCircuit] = useState({...activeCircuit}); 

            const updateField = (field, value) => setLocalCircuit(prev => ({ ...prev, [field]: value }));
            const maxZs = useMemo(() => getMaxZs(localCircuit.rating, localCircuit.curve), [localCircuit.rating, localCircuit.curve]);

            const handleSave = () => {
                setCircuits(prev => prev.map(c => c.id === localCircuit.id ? localCircuit : c));
                setView('dashboard');
            };

            const handleDelete = () => {
                if(window.confirm('Delete this circuit?')) {
                    setCircuits(prev => prev.filter(c => c.id !== localCircuit.id));
                    setView('dashboard');
                }
            };

            return (
                <div className="bg-gray-900 min-h-screen flex flex-col font-sans no-print">
                    <div className="bg-gray-800 px-4 pt-2 border-b border-gray-700 sticky top-0 z-30">
                        <div className="flex -mb-px space-x-8 overflow-x-auto">
                            {['wiring', 'protection', 'testing'].map((t) => (
                                <button key={t} onClick={() => setTab(t)} className={`pb-4 text-sm font-bold capitalize border-b-2 px-1 transition-colors ${tab === t ? 'border-yellow-400 text-yellow-400' : 'border-transparent text-gray-500'}`}>{t}</button>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 p-5 pb-32 overflow-y-auto">
                        {tab === 'wiring' && (
                            <div className="space-y-5 animate-fadeIn">
                                <div className="grid grid-cols-4 gap-3">
                                    <div className="col-span-1"><InputField label="No." value={localCircuit.ref} onChange={v => updateField('ref', v)} /></div>
                                    <div className="col-span-1"><InputField label="Pts" value={localCircuit.points} onChange={v => updateField('points', v)} type="number" /></div>
                                    <div className="col-span-2"><InputField label="Designation" value={localCircuit.name} onChange={v => updateField('name', v)} placeholder="e.g. Kitchen" /></div>
                                </div>
                                <SelectGroup label="Circuit Type" value={localCircuit.type} onChange={v => updateField('type', v)} options={CIRCUIT_TYPES} />
                                <SelectGroup label="Cable Type" value={localCircuit.cableType} onChange={v => updateField('cableType', v)} options={CABLE_TYPES} />
                                <div className="grid grid-cols-2 gap-4">
                                    <SelectGroup label="CSA (mm²)" value={localCircuit.csa} onChange={v => updateField('csa', v)} options={CSA_SIZES} />
                                    <InputField label="Comments (Optional)" value={localCircuit.comments} onChange={v => updateField('comments', v)} />
                                </div>
                            </div>
                        )}
                        {tab === 'protection' && (
                            <div className="space-y-5 animate-fadeIn">
                                <SelectGroup label="Device Type" value={localCircuit.deviceType} onChange={v => updateField('deviceType', v)} options={PROTECTIVE_DEVICES} icon={ShieldCheck} />
                                <div className="grid grid-cols-2 gap-4">
                                    <SelectGroup label="Rating (Amps)" value={localCircuit.rating} onChange={v => updateField('rating', v)} options={RATINGS} />
                                    <SelectGroup label="Curve / Type" value={localCircuit.curve} onChange={v => updateField('curve', v)} options={CURVES} />
                                </div>
                            </div>
                        )}
                        {tab === 'testing' && (
                            <div className="space-y-6 animate-fadeIn">
                                
                                <div className="bg-gray-800 p-5 rounded-xl border border-gray-700">
                                    <h4 className="text-sm font-bold text-gray-300 mb-4 border-b border-gray-700 pb-2">Continuity (Ω)</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <InputField label="Rp + Re" value={localCircuit.r1r2} onChange={v => updateField('r1r2', v)} type="number" step="0.01" />
                                        <InputField label="Re Only" value={localCircuit.re} onChange={v => updateField('re', v)} type="number" step="0.01" />
                                    </div>
                                    {/* Ring Circuit Fields */}
                                    {localCircuit.type === 'ring' && (
                                        <div className="mt-4 pt-4 border-t border-gray-700">
                                            <p className="text-xs text-blue-400 font-bold mb-2">Ring End-to-End</p>
                                            <div className="grid grid-cols-3 gap-2">
                                                <InputField label="L-L" value={localCircuit.ring_ll} onChange={v => updateField('ring_ll', v)} type="number" step="0.01" />
                                                <InputField label="N-N" value={localCircuit.ring_nn} onChange={v => updateField('ring_nn', v)} type="number" step="0.01" />
                                                <InputField label="E-E" value={localCircuit.ring_ee} onChange={v => updateField('ring_ee', v)} type="number" step="0.01" />
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="bg-gray-800 p-5 rounded-xl border border-gray-700">
                                    <h4 className="text-sm font-bold text-gray-300 mb-4 border-b border-gray-700 pb-2">Min. Insulation Res (MΩ)</h4>
                                    <div className="grid grid-cols-3 gap-2">
                                        <InputField label="Ph & N - E" value={localCircuit.riso_le} onChange={v => updateField('riso_le', v)} type="number" step="0.01" placeholder=">299" />
                                        <InputField label="Ph - N" value={localCircuit.riso_ln} onChange={v => updateField('riso_ln', v)} type="number" step="0.01" placeholder=">299" />
                                        <InputField label="3Ph Ph-Ph" value={localCircuit.riso_pp} onChange={v => updateField('riso_pp', v)} type="number" step="0.01" placeholder=">299" />
                                    </div>
                                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-600">
                                         <span className="text-sm text-gray-400 font-bold">Erroneous Test?</span>
                                         <button onClick={() => updateField('erroneousTest', !localCircuit.erroneousTest)} className={`p-2 rounded-lg transition-colors ${localCircuit.erroneousTest ? 'bg-yellow-500 text-gray-900' : 'bg-gray-600 text-gray-400'}`}>
                                            {localCircuit.erroneousTest ? 'YES' : 'NO'}
                                         </button>
                                    </div>
                                    <div className="flex items-center justify-between mt-4">
                                         <span className="text-sm text-gray-400 font-bold">Polarity Correct?</span>
                                         <button onClick={() => updateField('polarity', !localCircuit.polarity)} className={`p-2 rounded-lg transition-colors ${localCircuit.polarity ? 'bg-green-500 text-white' : 'bg-gray-600 text-gray-400'}`}>
                                            {localCircuit.polarity ? 'YES' : 'NO'}
                                         </button>
                                    </div>
                                </div>
                                
                                <div className="bg-gray-800 p-5 rounded-xl border border-gray-700">
                                    <div className="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                                        <h4 className="text-sm font-bold text-gray-300">Max Fault Loop (Zs)</h4>
                                        <span className="text-xs bg-gray-900 text-yellow-400 font-mono px-2 py-1 rounded border border-gray-700">Max: {maxZs}Ω</span>
                                    </div>
                                    <InputField label="L-E (Ohms)" value={localCircuit.zs} onChange={v => updateField('zs', v)} type="number" step="0.01" max={maxZs} />
                                </div>
                                
                                <div className="bg-gray-800 p-5 rounded-xl border border-gray-700">
                                    <h4 className="text-sm font-bold text-gray-300 mb-4 border-b border-gray-700 pb-2">Max RCD Operating Times (ms)</h4>
                                    <div className="grid grid-cols-3 gap-2">
                                        <InputField label="½x IΔn" value={localCircuit.rcd_half} onChange={v => updateField('rcd_half', v)} type="number" />
                                        <InputField label="1x IΔn" value={localCircuit.rcd_x1} onChange={v => updateField('rcd_x1', v)} type="number" max="300" />
                                        <InputField label="5x IΔn" value={localCircuit.rcd_x5} onChange={v => updateField('rcd_x5', v)} type="number" max="40" />
                                    </div>
                                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-600">
                                         <span className="text-sm text-gray-400 font-bold">Test Button Verified?</span>
                                         <button onClick={() => updateField('rcd_button', !localCircuit.rcd_button)} className={`p-2 rounded-lg transition-colors ${localCircuit.rcd_button ? 'bg-green-500 text-white' : 'bg-gray-600 text-gray-400'}`}>
                                            {localCircuit.rcd_button ? 'PASS' : 'UNTESTED'}
                                         </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-4 max-w-2xl mx-auto flex gap-3 shadow-2xl z-40">
                        <button onClick={handleDelete} className="p-4 text-red-400 bg-red-900/20 rounded-xl hover:bg-red-900/40 transition-colors"><Trash2 size={24} /></button>
                        <button onClick={handleSave} className="flex-1 bg-yellow-400 text-gray-900 font-bold rounded-xl py-3 flex items-center justify-center gap-2 hover:bg-yellow-300 shadow-lg shadow-yellow-400/10 transition-transform active:scale-[0.98]"><Save size={20} /> Save Circuit</button>
                    </div>
                </div>
            );
        };

        const ReportView = ({ installation, circuits, setView }) => {
            const today = installation.testDate || new Date().toISOString().split('T')[0];
            const maxRows = 16;
            const emptyRows = Math.max(0, maxRows - circuits.length);

            // Helpers to render checks box
            const CheckBox = ({ checked }) => (
                <div className={`check-box ${checked ? 'bg-black text-white' : ''}`}>
                    {checked ? '✓' : ''}
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-100 text-black p-0">
                    <div className="no-print fixed top-0 left-0 right-0 bg-gray-900 p-4 flex justify-between items-center z-50 shadow-md">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setView('dashboard')} className="text-gray-400 hover:text-white transition-colors"><ArrowLeft /></button>
                            <h2 className="text-white font-bold text-lg">Certificate Preview</h2>
                        </div>
                        <button onClick={() => window.print()} className="bg-yellow-400 text-gray-900 px-6 py-2 rounded-full font-bold flex items-center gap-2 hover:bg-yellow-300 shadow-lg shadow-yellow-400/20"><Printer size={18} /> Print PDF</button>
                    </div>

                    <div className="no-print h-20"></div>

                    <div className="overflow-auto flex justify-center pb-10 bg-gray-500/10">
                        {/* THE PDF REPLICA */}
                        <div className="print-sheet bg-white">
                            
                            {/* HEADER */}
                            <div className="flex items-end justify-between mb-2">
                                <div className="w-1/4">
                                    <div className="w-16 h-10 bg-blue-300 mb-1 border border-black flex items-center justify-center text-xs">LOGO</div>
                                    <div className="text-xs">Sheet .... of ....</div>
                                </div>
                                <div className="text-center w-1/2">
                                    <h1 className="text-title font-bold tracking-tight">TEST RECORD SHEET</h1>
                                </div>
                                <div className="w-1/3">
                                    <table className="w-full text-xs">
                                        <tbody>
                                            <tr>
                                                <td className="text-left font-bold w-32 border-black">Test Record Sheet No T</td>
                                                <td className="text-left border-black">{installation.recordNo}</td>
                                                <td className="text-left font-bold border-black">Seal No</td>
                                                <td className="text-left border-black">{installation.sealNo}</td>
                                            </tr>
                                            <tr>
                                                <td colSpan="2" className="text-left font-bold border-black">MPRN No</td>
                                                <td colSpan="2" className="text-left border-black font-mono tracking-widest">{installation.mprn}</td>
                                            </tr>
                                            <tr>
                                                <td colSpan="2" className="text-left font-bold border-black">Cert No</td>
                                                <td colSpan="2" className="text-left border-black">{installation.certNo}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* CUSTOMER & SITE INFO */}
                            <div className="text-xs space-y-1 mb-2">
                                <div className="flex items-end">
                                    <span className="w-32 font-bold uppercase">Customer Name:</span>
                                    <div className="flex-1 border-b-dotted border-black px-2 text-blue-900 uppercase">{installation.clientName}</div>
                                </div>
                                <div className="flex items-end">
                                    <span className="w-32 font-bold uppercase">Installation Address:</span>
                                    <div className="flex-1 border-b-dotted border-black px-2 text-blue-900 uppercase">{installation.address}</div>
                                </div>
                                <div className="flex items-end">
                                    <span className="w-32 font-bold uppercase">Distribution Board Ref:</span>
                                    <div className="w-48 border-b-dotted border-black px-2 uppercase">{installation.boardRef}</div>
                                </div>
                            </div>

                            {/* INSTALLATION TYPE */}
                            <div className="flex items-center text-xs mb-2 gap-4">
                                <span className="font-bold w-24 uppercase">Category:</span>
                                <div className="w-48 border-b-dotted border-black px-1 uppercase">{installation.category}</div>
                                <span className="text-[9px] italic text-gray-600">(Domestic, Commercial, Industrial etc.)</span>

                                <span className="font-bold ml-4 uppercase">Type of Installation:</span>
                                {['New', 'Rewire', 'Existing', 'Addition', 'Temp Supply'].map(type => (
                                    <div key={type} className="flex items-center gap-1">
                                        <span>{type}</span>
                                        <div className="check-box">{installation.type === type ? '✓' : ''}</div>
                                    </div>
                                ))}
                                <div className="flex items-center gap-1 flex-1">
                                    <span>Other (Specify)</span>
                                    <div className="border-b-dotted border-black flex-1"></div>
                                </div>
                            </div>

                            {/* COMMENTS */}
                            <div className="flex items-end text-xs mb-2">
                                <span className="font-bold mr-2">Comments:</span>
                                <div className="flex-1 border-b-dotted border-black px-2 text-xs">{installation.comments}</div>
                                <div className="w-1/3 flex gap-2 ml-4">
                                    <span>MAX Rp+Re (if applicable)</span>
                                    <span className="border-b-dotted border-black w-10 text-center">{installation.maxRpRe}</span>
                                    <span>OHMS</span>
                                    <span className="ml-2">MAX RES.PROT.COND (Re)</span>
                                    <span className="border-b-dotted border-black w-10 text-center">{installation.maxRe}</span>
                                    <span>OHMS</span>
                                </div>
                            </div>

                            {/* SPLIT SECTION: BONDING (Left) & INSTRUMENTS (Right) */}
                            <div className="flex gap-1 mb-1">
                                {/* LEFT: BONDING */}
                                <div className="w-1/3 text-[9px] font-bold">
                                    <div className="flex items-center mb-1">
                                        <span className="w-40 text-right mr-2">MAIN BONDING VERIFIED FOR:</span>
                                        <span className="w-8">GAS -</span>
                                        <span>YES</span> <CheckBox checked={installation.bonding?.Gas} />
                                        <span className="ml-1">N/A</span> <CheckBox checked={installation.bonding_na?.Gas} />
                                    </div>
                                    <div className="flex items-center mb-1">
                                        <span className="w-40 text-right mr-2"></span>
                                        <span className="w-8">WATER -</span>
                                        <span>YES</span> <CheckBox checked={installation.bonding?.Water} />
                                        <span className="ml-1">N/A</span> <CheckBox checked={installation.bonding_na?.Water} />
                                    </div>
                                    <div className="flex items-center mb-1">
                                        <span className="w-40 text-right mr-2">SUPPLEMENTARY BONDING VERIFIED -</span>
                                        <span>YES</span> <CheckBox checked={installation.bonding?.Supp} />
                                        <span className="ml-1">N/A</span> <CheckBox checked={installation.bonding_na?.Supp} />
                                    </div>
                                    <div className="flex items-center mb-1">
                                        <span className="w-40 text-right mr-2">ELECTRODE EARTHING CONDUCTOR -</span>
                                        <span>YES</span> <CheckBox checked={installation.bonding?.Electrode} />
                                        <span className="ml-1">N/A</span> <CheckBox checked={installation.bonding_na?.Electrode} />
                                    </div>
                                    <div className="flex items-center mb-1">
                                        <span className="w-40 text-right mr-2">OTHER -</span>
                                        <span>YES</span> 
                                        <span className="ml-1 font-normal">DETAILS</span>
                                        <span className="flex-1 border-b-dotted border-black ml-1"></span>
                                    </div>
                                </div>

                                /* RIGHT: INSTRUMENTS */
                                <div className="flex-1">
                                    <table className="w-full text-[9px] border-black">
                                        <thead>
                                            <tr>
                                                <th className="bg-gray-200 border-black text-red-800 font-bold uppercase w-1/3">Test Instruments Used</th>
                                                <th className="bg-gray-200 border-black text-red-800 font-bold uppercase w-1/3">Serial No</th>
                                                <th className="bg-gray-200 border-black text-red-800 font-bold uppercase w-1/3">Calibration Expiry Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td className="text-left pl-1">Insulation Resistance/Continuity</td><td>{installation.testerSerial}</td><td>{installation.testerExpiry}</td></tr>
                                            <tr><td className="text-left pl-1">Earth Loop Impedance</td><td>"</td><td>"</td></tr>
                                            <tr><td className="text-left pl-1">RCD</td><td>"</td><td>"</td></tr>
                                            <tr><td className="text-left pl-1">Multifunction</td><td>"</td><td>"</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* MAIN TABLE - THE COMPLEX GRID */}
                            <table className="w-full border-black mb-1 text-[8px]">
                                <thead>
                                    {/* ROW 1: Section Headers */}
                                    <tr className="h-4">
                                        <th colSpan="8" className="bg-print-black border-black text-left pl-2 font-bold uppercase text-xs">Circuit Details</th>
                                        <th colSpan="7" className="bg-print-blue border-black font-bold uppercase text-xs">Pre Connection</th>
                                        <th colSpan="6" className="bg-print-red border-black font-bold uppercase text-xs">Post Connection</th>
                                        <th rowSpan="3" className="w-24 border-black align-top text-left p-1 bg-white text-black font-normal">
                                            † - MCB / RCBO / Fuse etc.<br/>
                                            †† - Type B-C-D etc.<br/><br/>
                                            * Resistance of phase conductor (Rp)<br/>
                                            ** Resistance of earth conductor (Re)
                                        </th>
                                    </tr>

                                    {/* ROW 2: Column Groups */}
                                    <tr className="h-8">
                                        {/* Circuit Details Cols */}
                                        <th rowSpan="2" className="w-6"><div className="vertical-text">Circuit Number</div></th>
                                        <th rowSpan="2" className="w-auto">Circuit Designation</th>
                                        <th colSpan="2" className="h-4">Cable</th>
                                        <th rowSpan="2" className="w-6"><div className="vertical-text">No. of Points</div></th>
                                        <th colSpan="3" className="h-4">Overcurrent Protection</th>

                                        {/* Pre Connection Cols */}
                                        <th colSpan="2" className="h-4">Max Circuit Continuity (Ohms)</th>
                                        <th colSpan="3" className="h-4">Ring Circuit End to End</th>
                                        <th rowSpan="2" className="w-6"><div className="vertical-text">Erroneous Test Carried out (✓)</div></th>
                                        <th rowSpan="2" className="w-6"><div className="vertical-text">Polarity Correct (✓)</div></th>

                                        {/* Post Connection Cols */}
                                        <th rowSpan="2" className="w-10">L-E<br/>Max Fault<br/>Loop Imp.<br/>(Ohms)</th>
                                        <th colSpan="3" className="h-4">Max RCD Operating times (ms)</th>
                                        <th rowSpan="2" className="w-6"><div className="vertical-text">RCD Test Button Verified (✓)</div></th>
                                    </tr>

                                    {/* ROW 3: Specific Columns */}
                                    <tr className="h-16">
                                        {/* Cable Subcols */}
                                        <th className="w-8 vertical-text">Type</th>
                                        <th className="w-8 vertical-text">Sq mm</th>
                                        {/* Overcurrent Subcols */}
                                        <th className="w-8 vertical-text">Device †</th>
                                        <th className="w-8 vertical-text">Type ††</th>
                                        <th className="w-8 vertical-text">Amps</th>
                                        {/* Continuity Subcols */}
                                        <th className="w-10">All Circuits<br/>Rp* + Re**</th>
                                        <th className="w-8">Re**</th>
                                        {/* Ring Subcols */}
                                        <th className="w-8">L-L</th>
                                        <th className="w-8">N-N</th>
                                        <th className="w-8">E-E</th>
                                        
                                        {/* Post Conn Subcols */}
                                        <th className="w-8">½ x IΔn (✓)</th>
                                        <th className="w-8">1 x IΔn</th>
                                        <th className="w-8">5 x IΔn</th>
                                    </tr>
                                    
                                    {/* ROW 4: Sub-Sub Headers for Insulation (Merged into flow in Image but logic suggests they are headers for the Min Insulation Res section which shares space with Continuity? No, look at image. 
                                    Ah, "MIN INSULATION RES (MEG OHMS)" is actually distinct columns in the image. 
                                    Let's adjust. The Image has 3 columns for Insulation: Phase & Neutral to Earth, Phase to Neutral, 3 Phase Phase to Phase.
                                    Wait, in my grid above I put Ring Circuit cols where Insulation should be? 
                                    Let's re-read the image carefully.
                                    Pre Connection: 
                                    1. Max Circuit Continuity (Rp+Re, Re).
                                    2. Ring Circuit End to End (L-L, N-N, E-E) -- WAIT NO. The image shows blank headers there? No.
                                    It's: 
                                    - Max Circuit Continuity (Rp+Re, Re)
                                    - MIN. INSULATION RES (Phase&Neutral to Earth, Phase to Neutral, 3 Phase Phase to Phase).
                                    - Erroneous Test
                                    - Polarity
                                    
                                    WHERE IS RING CIRCUIT? 
                                    Ah, typically Ring Circuit data goes in the Continuity columns or separate? 
                                    Actually, looking at the image provided:
                                    The columns under Pre Connection are:
                                    1. Max Circuit Continuity (Rp+Re, Re)
                                    2. "Ring Circuit End to End" is WRITTEN above the column headers for L-L, N-N, E-E.
                                    Wait, the image provided has:
                                    Col 1: Rp*+Re**
                                    Col 2: Re**
                                    Col 3: L-L (Header says "Ring Circuit End to End" above cols 3,4,5?? No, looking at screenshot, "Ring Circuit End to End" is NOT there.
                                    Actually, looking at screenshot 20260214_091333_Drive.jpg:
                                    Under PRE CONNECTION:
                                    - Max Circuit Continuity (Ohms): [Rp* + Re**] [Re**]
                                    - MIN.INSULATION RES (MEG OHMS): [Phase & Neutral to Earth] [Phase to Neutral] [3 Phase Phase to Phase]
                                    - Erroneous Test (vert)
                                    - Polarity (vert)
                                    
                                    Wait, where did I see Ring Circuit? Ah, in standard ETCI sheets it's usually there. In THIS specific screenshot, "Ring Circuit End to End" is NOT explicitly a header column group. 
                                    However, look closely at the blank columns between Continuity and Insulation? No.
                                    Let's look really closely at the screenshot.
                                    Col group 1: Max Circuit Continuity. Subcols: Rp+Re, Re.
                                    Col group 2: MIN.INSULATION RES. Subcols: Phase & Neutral to Earth, Phase to Neutral, 3 Phase Phase to Phase.
                                    Col 3: Erroneous Test.
                                    Col 4: Polarity.
                                    
                                    There are NO dedicated columns for Ring L-L/N-N in this specific PDF screenshot. I will follow the screenshot EXACTLY.
                                    If user enters ring data, I won't print it in dedicated columns if they don't exist in the image. Or maybe I should reuse columns?
                                    Wait, look at row 4 of table (the header row).
                                    It says "L-L", "N-N", "E-E" in the screenshot?
                                    NO. It says: "Phase & Neutral to Earth", "Phase to Neutral", "3 Phase Phase to Phase".
                                    
                                    OKAY. STRICT ADHERENCE TO SCREENSHOT.
                                    Removes Ring L-L/N-N columns from the visual table.
                                    */}

                                    {/* RE-DOING HEADER ROW 3 TO MATCH SCREENSHOT EXACTLY */}
                                    <tr className="h-20 text-[7px]">
                                        <th className="w-8 vertical-text">Type</th>
                                        <th className="w-8 vertical-text">Sq mm</th>
                                        <th className="w-8 vertical-text">Device †</th>
                                        <th className="w-8 vertical-text">Type ††</th>
                                        <th className="w-8 vertical-text">Amps</th>
                                        
                                        {/* Pre Conn Details */}
                                        <th className="w-10">Rp* +<br/>Re**</th>
                                        <th className="w-8">Re**</th>
                                        
                                        {/* Insulation Details - These replace the Ring cols I had before */}
                                        <th className="w-10">Phase &<br/>Neutral<br/>to Earth<br/>(MΩ)</th>
                                        <th className="w-10">Phase to<br/>Neutral<br/>(MΩ)</th>
                                        <th className="w-10">3 Phase<br/>Phase to<br/>Phase<br/>(MΩ)</th>
                                        
                                        {/* Post Conn Details */}
                                        <th className="w-8">½ x<br/>IΔn<br/>(✓)</th>
                                        <th className="w-8">1 x IΔn</th>
                                        <th className="w-8">5 x IΔn</th>
                                        
                                        {/* Last col is Other Comments */}
                                        <th className="w-auto">Other Comments</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {/* FIXED ROW: Supply Cable */}
                                    <tr className="h-6 text-center text-blue-900 font-bold border-black">
                                        <td className="bg-white text-black">x</td>
                                        <td className="text-left pl-1">Supply Cable</td>
                                        <td>-</td><td>-</td><td>1</td><td>-</td><td>-</td><td>-</td>
                                        <td>-</td><td>-</td>
                                        <td>N/A</td><td>N/A</td><td>N/A</td>
                                        <td>-</td><td>-</td>
                                        <td className="text-black">{installation.ze}</td>
                                        <td>-</td><td>-</td><td>-</td><td>-</td>
                                        <td>-</td>
                                    </tr>

                                    {/* DYNAMIC ROWS */}
                                    {circuits.map((c) => (
                                        <tr key={c.id} className="h-6 text-center border-black">
                                            <td className="font-bold">{c.ref}</td>
                                            <td className="text-left pl-1 truncate font-medium">{c.name}</td>
                                            <td>{c.cableType}</td>
                                            <td>{c.csa}</td>
                                            <td>{c.points}</td>
                                            <td className="uppercase">{c.deviceType}</td>
                                            <td>{c.curve}</td>
                                            <td>{c.rating}</td>
                                            
                                            <td>{c.r1r2}</td>
                                            <td>{c.re}</td>
                                            
                                            {/* Insulation Columns */}
                                            <td>{c.riso_le}</td>
                                            <td>{c.riso_ln}</td>
                                            <td>{c.riso_pp}</td>
                                            
                                            <td>{c.erroneousTest ? '✓' : ''}</td>
                                            <td>{c.polarity ? '✓' : ''}</td>
                                            
                                            <td className="font-bold">{c.zs}</td>
                                            <td>{c.rcd_half}</td>
                                            <td>{c.rcd_x1}</td>
                                            <td>{c.rcd_x5}</td>
                                            <td>{c.rcd_button ? '✓' : ''}</td>
                                            <td className="text-left pl-1 text-[7px]">{c.comments}</td>
                                        </tr>
                                    ))}
                                    
                                    {/* FILLER ROWS */}
                                    {[...Array(emptyRows)].map((_, i) => (
                                        <tr key={`empty-${i}`} className="h-6 border-black">
                                            <td className="text-white">.</td>
                                            {[...Array(20)].map((_, j) => <td key={j}></td>)}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                            {/* FOOTER / SIGNATURES */}
                            <div className="flex justify-between items-end mt-4 text-[9px]">
                                <div className="w-full">
                                    <div className="flex mb-2">
                                        <span className="w-32">Pre Connection Tested By:</span>
                                        <div className="border-b-dotted border-black flex-1"></div>
                                        <span className="w-20 ml-4">SIGNATURE</span>
                                        <div className="border-b-dotted border-black flex-1 text-blue-900 font-script text-lg">{installation.engineerName}</div>
                                        <span className="w-10 ml-4">QC No.</span>
                                        <div className="border-b-dotted border-black w-20">{installation.qcNo}</div>
                                        <span className="w-10 ml-4">Reg No.</span>
                                        <div className="border-b-dotted border-black w-20">{installation.regNo}</div>
                                        <span className="w-10 ml-4">DATE</span>
                                        <div className="border-b-dotted border-black w-20">{today}</div>
                                    </div>
                                    <div className="flex">
                                        <span className="w-32">Post Connection Tested By:</span>
                                        <div className="border-b-dotted border-black flex-1"></div>
                                        <span className="w-20 ml-4">SIGNATURE</span>
                                        <div className="border-b-dotted border-black flex-1 text-blue-900 font-script text-lg">{installation.engineerName}</div>
                                        <span className="w-10 ml-4">QC No.</span>
                                        <div className="border-b-dotted border-black w-20">{installation.qcNo}</div>
                                        <span className="w-10 ml-4">Reg No.</span>
                                        <div className="border-b-dotted border-black w-20">{installation.regNo}</div>
                                        <span className="w-10 ml-4">DATE</span>
                                        <div className="border-b-dotted border-black w-20">{today}</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* BOTTOM LEGEND */}
                            <div className="text-[7px] text-center mt-2 text-gray-500">
                                Original To Customer-White &nbsp;&nbsp; Return to Electrical Safety Supervisory Body-Yellow &nbsp;&nbsp; Contractors record-Pink
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [activeCircuitId, setActiveCircuitId] = useState(null);
            
            // -- PERSISTENCE --
            const [installation, setInstallation] = useState(() => {
                const saved = localStorage.getItem('executive_install');
                return saved ? JSON.parse(saved) : {
                    mprn: '', clientName: '', address: '', earthingArrangement: 'TN-C-S', ze: '', type: 'New', 
                    category: 'Domestic', bonding: {}, bonding_na: {}, testerSerial: '', testerExpiry: '', recordNo: '', certNo: '', boardRef: '',
                    sealNo: '', comments: '', maxRpRe: '', maxRe: '', engineerName: '', qcNo: '', regNo: '', testDate: ''
                };
            });

            const [circuits, setCircuits] = useState(() => {
                const saved = localStorage.getItem('executive_circuits');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('executive_install', JSON.stringify(installation));
                localStorage.setItem('executive_circuits', JSON.stringify(circuits));
            }, [installation, circuits]);

            useEffect(() => {
                window.setActiveCircuitId = setActiveCircuitId;
            }, []);

            const createNewCircuit = () => ({
                id: Date.now(),
                ref: `${circuits.length + 1}`,
                name: '', type: 'socket', cableType: 'PVC', csa: '2.5', conductors: 3,
                deviceType: 'rcbo', rating: '20', curve: 'B', 
                r1r2: '', re: '', ring_ll: '', ring_nn: '', ring_ee: '',
                riso_ln: '', riso_le: '', riso_pp: '',
                zs: '', rcd_x1: '', rcd_x5: '', rcd_half: '', rcd_button: false, polarity: false, erroneousTest: false,
                points: '', comments: ''
            });

            const getStats = () => {
                const total = circuits.length;
                let completed = 0; let failed = 0;
                circuits.forEach(c => {
                    const isDone = c.zs && c.riso_le;
                    if (isDone) completed++;
                    const maxZs = getMaxZs(c.rating, c.curve);
                    if (c.zs && parseFloat(c.zs) > parseFloat(maxZs)) failed++;
                });
                return { total, completed, failed };
            };

            const handleReset = () => {
                if(window.confirm("Delete everything? This cannot be undone.")) {
                    setCircuits([]);
                    setInstallation({ mprn: '', clientName: '', address: '', earthingArrangement: 'TN-C-S', ze: '', type: 'New', bonding: {}, bonding_na: {} });
                    localStorage.clear();
                }
            };

            const activeCircuit = circuits.find(c => c.id === activeCircuitId);
            const stats = getStats();

            return (
                <div className="font-sans text-gray-100 max-w-2xl mx-auto bg-gray-900 min-h-screen shadow-2xl border-x border-gray-800">
                    {view !== 'report' && <Header view={view} onBack={() => setView('dashboard')} title={view === 'dashboard' ? 'Test Record' : view === 'details' ? 'Edit Details' : 'Circuit Editor'} />}
                    {view === 'dashboard' && <Dashboard installation={installation} circuits={circuits} stats={stats} setView={setView} createNewCircuit={() => {
                        const newC = createNewCircuit();
                        setCircuits([...circuits, newC]);
                        setActiveCircuitId(newC.id);
                        setView('edit-circuit');
                    }} handleReset={handleReset} />}
                    {view === 'edit-circuit' && activeCircuit && <CircuitEditor activeCircuit={activeCircuit} setCircuits={setCircuits} setView={setView} />}
                    {view === 'details' && <DetailsEditor installation={installation} setInstallation={setInstallation} setView={setView} />}
                    {view === 'report' && <ReportView installation={installation} circuits={circuits} setView={setView} />}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

