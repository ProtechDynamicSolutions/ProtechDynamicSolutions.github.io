<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kavanagh Crane Hire - Quote Tool</title>
    <link rel="icon" href="https://kavanaghcranehire.ie/wp-content/uploads/2024/07/quick-quote-chevron-colors-bg.svg" type="image/svg+xml">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-yellow': '#fecb00',
                        'brand-black': '#1a1a1a',
                        'kavanagh-blue': '#00CCFF',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f4f4f5; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #fecb00; }
        
        .white-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(228, 228, 231, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 5px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fecb00;
            cursor: pointer;
            transition: background .15s ease-in-out;
        }
        input[type=range]::-webkit-slider-thumb:hover { background: #eab308; }
        body { background-color: #f8fafc; color: #1e293b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            FileText, Share, Calendar, MapPin, User, Truck, Phone, 
            Euro, ShieldCheck, Map, HardHat, Clock, Mail, AlertTriangle, 
            FileCheck, Users, Briefcase, TruckIcon, BedDouble, CalendarClock, 
            Settings, Minus, Plus, X, Box, CloudLightning, RefreshCw
        } from 'lucide-react';

        const ADVISERS_DATA = [
            { name: "Seán O'Herlihy", phone: "083 470 0338", email: "sean.oherlihy@kchcranes.ie" },
            { name: "James Dunne", phone: "087 814 1484", email: "james.dunne@kchcranes.ie" }
        ];

        const getInitials = (name) => {
            const parts = name.split(/[ ']/).filter(Boolean);
            return parts.map(p => p[0]).join('').toUpperCase();
        };

        const ADVISERS = ADVISERS_DATA.map(a => ({
            ...a,
            initials: getInitials(a.name)
        }));

        const CRANE_RATES = {
            40: 75, 50: 90, 60: 95, 80: 110, 90: 120, 100: 135,
            110: 145, 130: 185, 150: 200, 220: 285, 230: 300,
            300: 350, 450: 500, 500: 550
        };

        const getRateForCrane = (craneString) => {
            const match = craneString.match(/\((\d+)t\)/);
            if (!match) return 75; 
            const tons = parseInt(match[1]);
            if (tons <= 40) return 75;
            if (CRANE_RATES[tons]) return CRANE_RATES[tons];
            return 75;
        };

        const CRANE_LIST = [
            {
                category: "Spider & Self-Erecting Cranes",
                cranes: ["Maeda MC285C-3", "Liebherr MK140-5.1", "Spierings SK 1265 (6-Axle)"]
            },
            {
                category: "City & All Terrain Cranes",
                cranes: [
                    "Demag AC30 City (30t)", "Demag AC40-2L (40t)", "Demag AC40 City (40t)",
                    "Liebherr LTM 1040-2.1 (40t)", "Demag AC45 City (45t)", "Liebherr LTF 1045-4.1 (45t)",
                    "Liebherr LTC 1050-3.1 (50t)", "Demag AC50-1 (50t)", "Demag AC55 City (55t)",
                    "Liebherr LTF 1060-4.1 (60t)", "Grove GMK3060 (60t)", "Demag AC60-3L (60t)",
                    "Liebherr LTR 1060 (60t Crawler)", "Liebherr LTM 1060-3.1 (60t)", "Demag AC80-2 (80t)",
                    "Liebherr LTM 1090-4.1 (90t)", "Liebherr LTM 1090-4.2 (90t)", "Tadano ATF 90G-4 (90t)",
                    "Demag AC100-4L (100t)", "Grove GMK4100-4L (100t)", "Liebherr LTM 1100-5.2 (100t)",
                    "Tadano ATF 100G-4 (100t)", "Liebherr LTM 1110-5.1 (110t)", "Demag AC120-1 (120t)",
                    "Grove GMK5130-2 (130t)", "Liebherr LTM 1130-5.1 (130t)", "Liebherr LTM 1150-5.3 (150t)",
                    "Demag AC220-5 (220t)", "Liebherr LTM 1230-5.1 (230t)", "Liebherr LTM 1300-6.2 (300t)",
                    "Liebherr LTM 1300-6.3 (300t)", "Liebherr LTM 1450-8.1 (450t)", "Liebherr LTM 1500-8.1 (500t)",
                    "Liebherr LTM 1650-8.1 (700t)", "Liebherr LTM 1750-9.1 (800t)"
                ]
            }
        ];

        const formatNumber = (num) => {
            return num.toLocaleString('en-IE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return <div className="p-8 text-center"><h2 className="text-red-500 font-bold">Something went wrong</h2><button onClick={() => window.location.reload()} className="mt-4 bg-black text-white px-4 py-2 rounded">Reload</button></div>;
                }
                return this.props.children;
            }
        }

        const InputGroup = ({ label, icon: Icon, children }) => (
            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm focus-within:ring-2 focus-within:ring-yellow-400 transition-all group hover:border-slate-300">
                <label className="flex items-center gap-2 text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest group-focus-within:text-yellow-600 transition-colors">
                    {Icon && <Icon size={12} />} {label}
                </label>
                {children}
            </div>
        );

        const TextInput = ({ ...props }) => (
            <input {...props} className="w-full bg-transparent outline-none text-slate-800 font-semibold placeholder-slate-400 text-sm" />
        );

        const Stepper = ({ label, value, onChange, step = 1, min = 0 }) => {
            const handleDec = () => onChange(Math.max(min, parseFloat(value) - step));
            const handleInc = () => onChange(parseFloat(value) + step);
            return (
                <div className="flex flex-col bg-white rounded-lg border border-slate-200 p-2">
                    <span className="text-[10px] font-bold text-slate-400 uppercase mb-1 block text-center">{label}</span>
                    <div className="flex items-center justify-between gap-2">
                        <button type="button" onClick={handleDec} className="w-8 h-8 rounded-full bg-slate-100 hover:bg-yellow-100 flex items-center justify-center"><Minus size={14}/></button>
                        <span className="font-bold text-slate-900 text-lg w-10 text-center">{value}</span>
                        <button type="button" onClick={handleInc} className="w-8 h-8 rounded-full bg-slate-100 hover:bg-yellow-100 flex items-center justify-center"><Plus size={14}/></button>
                    </div>
                </div>
            );
        };

        function AppContent() {
            const [isGenerating, setIsGenerating] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [quoteRef, setQuoteRef] = useState('Checking...');
            const [showNotesModal, setShowNotesModal] = useState(false);

            const initialRate = getRateForCrane('Demag AC50-1 (50t)');

            const [formData, setFormData] = useState({
                adviserName: ADVISERS[0].name,
                adviserInitials: ADVISERS[0].initials,
                adviserEmail: ADVISERS[0].email,
                adviserPhone: ADVISERS[0].phone,
                clientName: '',
                clientEmail: '',
                date: new Date().toISOString().split('T')[0],
                craneType: 'Demag AC50-1 (50t)',
                mobHours: 1.0,
                demobHours: 1.0,
                siteHours: 8.0,
                hourlyRate: initialRate,
                overtimeRate: initialRate + 35, 
                addVat: false, 
                siteAddress: 'Cork',
                contactNumber: '',
                liftPlanRequired: false,
                liftPlanCost: 150.00,
                liftPlanIncluded: false,
                spreaderBars: true,
                spreaderCost: 200.00,
                accommodation: true,
                accommodationCost: 150.00,
                weekendCharge: true,
                weekendCost: 35.00,
                apRequired: false,
                apCount: 1,
                apCost: 75.00,
                apIncluded: false,
                banksmanRequired: false,
                banksmanCount: 1,
                banksmanCost: 50.00,
                banksmanIncluded: false,
                ballastRequired: false,
                ballastCost: 600.00,
                otherItemsRequired: false,
                otherItemsDesc: '',
                otherItemsCost: ''
            });

            const totalMinHours = parseFloat(formData.mobHours) + parseFloat(formData.demobHours) + parseFloat(formData.siteHours);

            // --- 1. GENERATE JOB NUMBER (TIMESTAMP BASED) ---
            const fetchNextQuoteNumber = async (initials) => {
                const now = new Date();
                const yy = now.getFullYear().toString().slice(-2);
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const min = String(now.getMinutes()).padStart(2, '0');
                
                return `${initials}-${yy}${mm}${dd}${hh}${min}`;
            };

            // --- USE EFFECT: Fetch Number on Mount & Change ---
            useEffect(() => {
                let mounted = true;
                const getNum = async () => {
                    const num = await fetchNextQuoteNumber(formData.adviserInitials);
                    if (mounted) setQuoteRef(num);
                };
                getNum();
                return () => { mounted = false; };
            }, [formData.adviserInitials]);


            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handleCraneChange = (e) => {
                const newCrane = e.target.value;
                const newRate = getRateForCrane(newCrane);
                setFormData(prev => ({
                    ...prev,
                    craneType: newCrane,
                    hourlyRate: newRate,
                    overtimeRate: newRate + 35
                }));
            };

            const handleAdviserChange = (e) => {
                const selected = ADVISERS.find(a => a.name === e.target.value);
                setFormData(prev => ({
                    ...prev,
                    adviserName: selected.name,
                    adviserInitials: selected.initials,
                    adviserEmail: selected.email,
                    adviserPhone: selected.phone
                }));
            };

            const updateHours = (field, newVal) => setFormData(prev => ({ ...prev, [field]: newVal }));

            const getBase64ImageFromURL = (url) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.setAttribute("crossOrigin", "anonymous");
                    img.onload = () => {
                        const c = document.createElement("canvas");
                        c.width = img.width; c.height = img.height;
                        resolve(c.getContext("2d").drawImage(img, 0, 0) || c.toDataURL("image/png"));
                    };
                    img.onerror = () => resolve(null);
                    img.src = url;
                });
            };

            const handleGenerate = async () => {
                if (!window.jspdf) return;
                setIsGenerating(true);

                let uniqueRef = quoteRef;
                if (!uniqueRef || uniqueRef.includes('Loading') || uniqueRef.includes('ERR')) {
                     uniqueRef = await fetchNextQuoteNumber(formData.adviserInitials);
                     setQuoteRef(uniqueRef);
                }

                // 2. Calculate Total for PDF
                const hourlyRateVal = parseFloat(formData.hourlyRate || 0);
                let subTotal = totalMinHours * hourlyRateVal;
                
                if (formData.liftPlanRequired && !formData.liftPlanIncluded) subTotal += parseFloat(formData.liftPlanCost);
                if (formData.apRequired && !formData.apIncluded) subTotal += (parseFloat(formData.apCost || 0) * parseInt(formData.apCount));
                if (formData.banksmanRequired && !formData.banksmanIncluded) subTotal += (parseFloat(formData.banksmanCost || 0) * parseInt(formData.banksmanCount));
                if (formData.ballastRequired) subTotal += (parseFloat(formData.ballastCost || 0) * 2);
                if (formData.otherItemsRequired) subTotal += parseFloat(formData.otherItemsCost || 0);
                
                const vatAmount = formData.addVat ? (subTotal * 0.23) : 0;
                const grandTotal = subTotal + vatAmount;

                // 3. Generate PDF
                await generatePDF(uniqueRef, grandTotal, subTotal, vatAmount);
            };

            const generatePDF = async (uniqueRef, grandTotal, subTotal, vatAmount) => {
                setStatusMsg('Generating PDF...');

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const yellow = [254, 203, 0]; 
                    const black = [20, 20, 20]; 
                    const darkGrey = [60, 60, 60]; 
                    const lightGrey = [240, 240, 240]; 

                    const [headerBg, craneImg, logo50, isoImg, kavLogo] = await Promise.all([
                        getBase64ImageFromURL("https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/KavCranes.jpg"),
                        getBase64ImageFromURL("https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/ltm-1650-8.1.jpg"),
                        getBase64ImageFromURL("https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/Kav50.png"),
                        getBase64ImageFromURL("https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/refs/heads/main/Kavanagh/KavISO.png"),
                        getBase64ImageFromURL("https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/KavLogo.png")
                    ]);

                    const drawFooter = () => {
                        const fY = 270; 
                        doc.setFillColor(26, 26, 26);
                        doc.rect(0, fY, 210, 27, 'F');
                        doc.setTextColor(...yellow);
                        doc.setFont("helvetica", "bold"); doc.setFontSize(10);
                        doc.text("THE CERTIFICATION PROCESS", 20, fY + 8);
                        doc.setTextColor(220, 220, 220); 
                        doc.setFont("helvetica", "normal"); doc.setFontSize(7.5); 
                        doc.text(doc.splitTextToSize("We partnered with Amtivo (formerly Certification Europe) for their strong industry reputation and INAB-accreditation. Working with a consultant, we aligned our systems with ISO 9001, ISO 14001, and ISO 45001 standards.", 110), 20, fY + 14);
                        if (isoImg) doc.addImage(isoImg, 'PNG', 135, fY + 5, 55, 20);
                    };

                    const drawSidebarContact = (sY, sideX) => {
                        doc.setTextColor(...black); doc.setFont("helvetica", "bold"); doc.setFontSize(10);
                        doc.text("CONTACT US", sideX + 25, sY, { align: "center" });
                        sY += 8;
                        doc.setFontSize(9);
                        doc.text("Sales Rep", sideX + 25, sY, { align: "center" });
                        sY += 5;
                        doc.setTextColor(...darkGrey); doc.setFontSize(10); doc.setFont("helvetica", "normal"); 
                        doc.text(formData.adviserName, sideX + 25, sY, { align: "center" });
                        sY += 8;
                        doc.setFontSize(9); doc.setFont("helvetica", "bold"); doc.setTextColor(...black);
                        doc.text("Mobile:", sideX + 25, sY, { align: "center" });
                        doc.setFont("helvetica", "normal"); doc.setTextColor(...darkGrey); sY += 5;
                        doc.text(formData.adviserPhone, sideX + 25, sY, { align: "center" });
                        sY += 8;
                        doc.setFont("helvetica", "bold"); doc.setTextColor(...black);
                        doc.text("Email:", sideX + 25, sY, { align: "center" });
                        doc.setFont("helvetica", "normal"); doc.setTextColor(...darkGrey); sY += 5;
                        doc.text(formData.adviserEmail, sideX + 25, sY, { align: "center" }); 
                        return sY + 5; // Return Y with small padding
                    }

                    // PAGE 1
                    if (headerBg) doc.addImage(headerBg, 'JPEG', 0, 0, 210, 50);
                    doc.setGState(new doc.GState({ opacity: 0.9 })); doc.setFillColor(...yellow); doc.rect(0, 0, 210, 50, 'F'); doc.setGState(new doc.GState({ opacity: 1.0 }));
                    if (kavLogo) doc.addImage(kavLogo, 'PNG', 15, 10, 60, 20); 

                    doc.setTextColor(...black); doc.setFontSize(11); doc.setFont("helvetica", "bold");
                    doc.text(`Quote Ref: ${uniqueRef}`, 190, 25, { align: "right" });

                    doc.setFillColor(...black); doc.rect(0, 50, 210, 10, 'F');
                    doc.setTextColor(255, 255, 255); doc.setFontSize(11); doc.setFont("times", "italic");
                    doc.text("Elevating Excellence Since 1973 - Where Commitment Meets Capability!", 105, 56, { align: "center" });
                    doc.setFont("helvetica", "normal");

                    let y = 75; const mainX = 20; const fullW = 170;
                    doc.setTextColor(...black); doc.setFont("helvetica", "bold"); doc.setFontSize(14);
                    doc.text("PROPOSAL", mainX, y);
                    doc.setDrawColor(...yellow); doc.setLineWidth(1); doc.line(mainX, y+2, mainX+30, y+2); y += 10;

                    doc.setTextColor(...darkGrey); doc.setFont("helvetica", "normal"); doc.setFontSize(10.5); 
                    const intro = doc.splitTextToSize("Thank you for giving Kavanagh Crane Hire the opportunity to submit this proposal. Since our formation in 1973 we have gained a wealth of experience and knowledge within the industry. We are committed to maintaining the most modern and advanced equipment there is.\n\nProudly supplying crane hire nationwide, we operate from five strategically located depots in Cork, Dublin, Wexford, Waterford, and Carlow. This network keeps us within close proximity to any job, allowing us to deliver expert crane hire and specialised heavy lift engineering solutions across a range of industries. Backed by years of experience and continuous investment in our state-of-the-art equipment,\nour local presence ensures fast, efficient, and reliable service for projects of all sizes.", fullW);
                    doc.text(intro, mainX, y); y += (intro.length * 6) + 10;

                    if (craneImg) doc.addImage(craneImg, 'JPEG', (210 - 170)/2, y, 170, 80);
                    drawFooter();

                    // PAGE 2
                    doc.addPage();
                    doc.setFillColor(...yellow); doc.rect(0, 0, 210, 32, 'F'); 
                    if (kavLogo) doc.addImage(kavLogo, 'PNG', 20, 5, 45, 15);
                    doc.setTextColor(...black); doc.setFont("helvetica", "bold"); doc.setFontSize(10);
                    doc.text(`Quote Ref: ${uniqueRef}`, 190, 20, { align: "right" });

                    let sY = 50; 
                    const sideX = 140; 
                    if (logo50) { 
                        doc.addImage(logo50, 'PNG', sideX + 5, sY, 40, 32); 
                        sY += 40; 
                    }
                    doc.setDrawColor(200, 200, 200); doc.line(sideX, sY, sideX+50, sY); sY += 10;
                    doc.text("LOCATIONS", sideX + 25, sY, { align: "center" }); sY += 8;
                    doc.setTextColor(...darkGrey); doc.setFont("helvetica", "normal"); doc.setFontSize(9);
                    ["Dublin", "Cork", "Wexford", "Waterford", "Carlow"].forEach(l => { doc.text(l, sideX + 25, sY, { align: "center" }); sY += 5; });
                    sY += 10; doc.setDrawColor(200, 200, 200); doc.line(sideX, sY, sideX+50, sY); sY += 10;
                    
                    const sidebarBottom = drawSidebarContact(sY, sideX);

                    // Main Content
                    y = 50; 
                    const contentW = 110;
                    doc.setFontSize(14); doc.setTextColor(...black); doc.setFont("helvetica", "bold");
                    doc.text("JOB SPECIFICATION", mainX, y); y += 10;

                    // Table Header
                    doc.setFillColor(...black);
                    doc.rect(mainX, y, contentW, 8, 'F');
                    doc.setTextColor(...yellow); doc.setFontSize(9); doc.setFont("helvetica", "bold");
                    doc.text("DESCRIPTION", mainX + 4, y + 5.5);
                    doc.text("DETAILS / COST", mainX + contentW - 4, y + 5.5, { align: 'right' });
                    y += 8;

                    let rowAlt = false;

                    const drawRow = (label, value, isBold = false) => {
                        if (rowAlt) { doc.setFillColor(...lightGrey); doc.rect(mainX, y, contentW, 7, 'F'); }
                        
                        doc.setTextColor(...black); doc.setFontSize(9); 
                        doc.setFont("helvetica", isBold ? "bold" : "normal");
                        doc.text(label, mainX + 4, y + 5);
                        
                        doc.setTextColor(...darkGrey);
                        doc.setFont("helvetica", isBold ? "bold" : "normal");
                        doc.text(value, mainX + contentW - 4, y + 5, { align: 'right' });
                        
                        doc.setDrawColor(220, 220, 220); doc.setLineWidth(0.1);
                        doc.line(mainX, y + 7, mainX + contentW, y + 7);
                        
                        y += 7;
                        rowAlt = !rowAlt;
                    };

                    drawRow("Customer Name", formData.clientName || "-");
                    drawRow("Site Address", formData.siteAddress || "-");
                    drawRow("Customer Email", formData.clientEmail || "-");
                    drawRow("Contact Number", formData.contactNumber || "-");
                    drawRow("Crane Type", formData.craneType);
                    drawRow("Total Minimum Hours", `${totalMinHours} Hours`);
                    drawRow("Hourly Rate", `EUR ${formatNumber(parseFloat(formData.hourlyRate || 0))}`);
                    
                    if (formData.liftPlanRequired) {
                        drawRow("Lift Plan", formData.liftPlanIncluded ? "Included" : `EUR ${formatNumber(parseFloat(formData.liftPlanCost))}`);
                    }
                    if (formData.apRequired) {
                        drawRow(`Lift Supervisor (x${formData.apCount})`, formData.apIncluded ? "Included" : `EUR ${formatNumber(parseFloat(formData.apCost)*formData.apCount)}`);
                    }
                    if (formData.banksmanRequired) {
                        drawRow(`Banksman (x${formData.banksmanCount})`, formData.banksmanIncluded ? "Included" : `EUR ${formatNumber(parseFloat(formData.banksmanCost)*formData.banksmanCount)}`);
                    }
                    if (formData.ballastRequired) {
                        drawRow("Ballast Truck (x2 trips)", `EUR ${formatNumber(parseFloat(formData.ballastCost || 0) * 2)}`);
                    }
                    if (formData.otherItemsRequired) {
                        const oDesc = formData.otherItemsDesc || "Additional Item";
                        drawRow(oDesc, `EUR ${formatNumber(parseFloat(formData.otherItemsCost))}`);
                    }

                    y += 4; rowAlt = false;
                    
                    if (formData.addVat) {
                        doc.setFont("helvetica", "bold"); doc.setTextColor(...black);
                        doc.text("Subtotal (Ex VAT)", mainX + 4, y + 5);
                        doc.text(`EUR ${formatNumber(subTotal)}`, mainX + contentW - 4, y + 5, { align: 'right' });
                        doc.setDrawColor(0,0,0); doc.line(mainX, y+7, mainX+contentW, y+7);
                        y += 8;

                        doc.setFont("helvetica", "normal");
                        doc.text("VAT (23%)", mainX + 4, y + 5);
                        doc.text(`EUR ${formatNumber(vatAmount)}`, mainX + contentW - 4, y + 5, { align: 'right' });
                        y += 8;
                    }

                    doc.setFillColor(254, 252, 232); 
                    doc.rect(mainX, y, contentW, 10, 'F');
                    doc.setDrawColor(...yellow); doc.setLineWidth(0.5); doc.rect(mainX, y, contentW, 10);
                    
                    doc.setFont("helvetica", "bold"); doc.setFontSize(10); doc.setTextColor(200, 0, 0); 
                    doc.text(formData.addVat ? "TOTAL (Inc VAT)" : "TOTAL MIN. CHARGE (Ex VAT)", mainX + 4, y + 6.5);
                    doc.text(`EUR ${formatNumber(grandTotal)}`, mainX + contentW - 4, y + 6.5, { align: 'right' });
                    
                    // --- OVERLAP & SPACING OPTIMIZATION ---
                    y += 10; // Tightened spacing after total box (was 18)
                    
                    // Compact buffer between sidebar and notes
                    if (y < sidebarBottom + 6) {
                        y = sidebarBottom + 6;
                    }

                    // PAGE BREAK CHECK
                    if (y > 230) { doc.addPage(); y = 40; }

                    doc.setTextColor(...black); doc.setFont("helvetica", "bold"); doc.setFontSize(12);
                    doc.text("INSURANCE & NOTES", mainX, y); y += 8;
                    doc.setTextColor(...darkGrey); doc.setFont("helvetica", "normal"); doc.setFontSize(8); 
                    
                    const noteLines = [
                        `ADDITIONAL CHARGES: All Saturday, Sunday, and Bank Holiday hours (including travel) are outside normal working hours and charged at an additional EUR ${formatNumber(parseFloat(formData.weekendCost))} per hour. Accommodation, if required, is charged at EUR ${formatNumber(parseFloat(formData.accommodationCost))} per night.`,
                        "",
                        "EQUIPMENT & LIABILITY: Standard lifting tackle (chains, slings & shackles) is included; specialist tackle is available at an additional cost. Please Note: Due to fluctuating fuel prices, quotes are subject to change upon confirmation of dates. Kavanagh Crane Hire Ltd accepts no responsibility for damage to ground during the hire period.",
                        "",
                        "INSURANCE HELD: On-Hook: EUR 1m | Height: Unlimited | Employers Liability: EUR 13m | Public Liability: EUR 10m (Primary) & EUR 10m (Excess). (On-hook and Height insurance are above industry standards)"
                    ];
                    
                    if (formData.spreaderBars) {
                         noteLines.splice(1, 0, `• Delivery & Collection of Spreader Bars EUR ${formatNumber(parseFloat(formData.spreaderCost))} E/W`);
                    }

                    noteLines.forEach(line => {
                        const lines = doc.splitTextToSize(line, fullW);
                        const lineH = 3.5; // Compact line height (was 4)
                        
                        // Allow writing lower on the page (up to 275) to fit 2 pages
                        if (y + (lines.length * lineH) > 275) {
                            doc.addPage();
                            y = 40; 
                        }
                        doc.text(lines, mainX, y); 
                        y += (lines.length * lineH) + 1; // Reduced paragraph spacing (was +2)
                    });
                    
                    if (y < 265) drawFooter(); 

                    const blob = doc.output('blob');
                    const file = new File([blob], `${uniqueRef}.pdf`, { type: 'application/pdf' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: `Quote ${uniqueRef}` });
                        setStatusMsg('Quote Shared');
                    } else {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = file.name; a.click();
                        setStatusMsg('Quote Downloaded');
                    }

                } catch (err) { console.error(err); setStatusMsg(`Error: ${err.message}`); }
                setTimeout(() => { setIsGenerating(false); setStatusMsg(''); }, 3000);
            };

            return (
                <div className="min-h-screen relative flex flex-col pb-24 bg-slate-50">
                    <nav className="sticky top-0 z-50 bg-brand-yellow shadow-md border-b border-yellow-500">
                        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
                             <div className="flex items-center gap-3">
                                <img src="https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/KavLogo.png" alt="Kavanagh" className="h-10 w-auto object-contain" onError={(e) => e.target.style.display = 'none'} />
                             </div>
                             <div className="px-3 py-1 flex items-center gap-2">
                                <span className="text-xs font-mono font-bold text-slate-800 tracking-wide">
                                    {quoteRef || "---"}
                                </span>
                             </div>
                        </div>
                    </nav>

                    {showNotesModal && (
                        <div className="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 relative">
                                <button onClick={() => setShowNotesModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={20} /></button>
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Settings size={18} className="text-yellow-500"/> Configure Standard Notes</h3>
                                <div className="space-y-4">
                                    <div className="flex flex-col gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-700 flex items-center gap-2"><TruckIcon size={16}/> Spreader Bars</span><input type="checkbox" name="spreaderBars" checked={formData.spreaderBars} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/></div>
                                        {formData.spreaderBars && (<div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400">€</span><input type="number" name="spreaderCost" value={formData.spreaderCost} onChange={handleChange} className="w-24 text-sm p-1 border rounded" /><span className="text-xs text-slate-400">E/W</span></div>)}
                                    </div>
                                    <div className="flex flex-col gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-700 flex items-center gap-2"><BedDouble size={16}/> Accommodation</span><input type="checkbox" name="accommodation" checked={formData.accommodation} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/></div>
                                        {formData.accommodation && (<div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400">€</span><input type="number" name="accommodationCost" value={formData.accommodationCost} onChange={handleChange} className="w-24 text-sm p-1 border rounded" /><span className="text-xs text-slate-400">P/Night</span></div>)}
                                    </div>
                                    <div className="flex flex-col gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="flex justify-between items-center"><span className="text-sm font-bold text-slate-700 flex items-center gap-2"><CalendarClock size={16}/> Weekend Surcharge</span><input type="checkbox" name="weekendCharge" checked={formData.weekendCharge} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/></div>
                                        {formData.weekendCharge && (<div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-400">€</span><input type="number" name="weekendCost" value={formData.weekendCost} onChange={handleChange} className="w-24 text-sm p-1 border rounded" /><span className="text-xs text-slate-400">/hr</span></div>)}
                                    </div>
                                </div>
                                <button onClick={() => setShowNotesModal(false)} className="w-full mt-6 bg-brand-black text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition-colors">Done</button>
                            </div>
                        </div>
                    )}

                    <main className="flex-grow w-full max-w-3xl mx-auto px-4 py-6 relative z-10 space-y-6">
                        <div className="white-panel p-6 rounded-2xl relative overflow-hidden flex justify-between items-start">
                             <div>
                                 <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-400/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
                                 <h2 className="text-xl font-bold text-slate-800 mb-1 flex items-center gap-2"><FileText className="text-brand-yellow" size={24} /> Quote Generator</h2>
                             </div>
                             <button onClick={() => setShowNotesModal(true)} className="bg-slate-100 p-2 rounded-full hover:bg-yellow-100 hover:text-yellow-600 transition-colors z-10"><Settings size={20} /></button>
                        </div>

                        <div className="space-y-4 animate-fade-in grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <InputGroup label="Crane Adviser" icon={HardHat}>
                                    <div className="relative">
                                        <select name="adviser" value={formData.adviserName} onChange={handleAdviserChange} className="w-full bg-transparent outline-none text-slate-900 font-bold appearance-none text-sm cursor-pointer">
                                            {ADVISERS.map(adv => <option key={adv.initials} value={adv.name}>{adv.name}</option>)}
                                        </select>
                                    </div>
                                </InputGroup>
                            </div>

                            <InputGroup label="Date" icon={Calendar}><TextInput type="date" name="date" value={formData.date} onChange={handleChange} /></InputGroup>
                            <InputGroup label="Client Name" icon={User}><TextInput name="clientName" placeholder="Company / Contact" value={formData.clientName} onChange={handleChange} /></InputGroup>
                            <InputGroup label="Client Email" icon={Mail}><TextInput type="email" name="clientEmail" placeholder="client@email.com" value={formData.clientEmail} onChange={handleChange} /></InputGroup>
                            <InputGroup label="Client Phone" icon={Phone}><TextInput type="tel" name="contactNumber" placeholder="08X..." value={formData.contactNumber} onChange={handleChange} /></InputGroup>
                            <div className="md:col-span-2"><InputGroup label="Site Address" icon={MapPin}><TextInput name="siteAddress" value={formData.siteAddress} onChange={handleChange} /></InputGroup></div>

                            <div className="md:col-span-2">
                                <InputGroup label="Crane Model" icon={Truck}>
                                    <div className="relative">
                                        <select name="craneType" value={formData.craneType} onChange={handleCraneChange} className="w-full bg-transparent outline-none text-slate-800 font-semibold appearance-none text-sm cursor-pointer">
                                            {CRANE_LIST.map((group) => (
                                                <optgroup key={group.category} label={group.category} className="text-yellow-600 bg-white">
                                                    {group.cranes.map((crane) => <option key={crane} value={crane} className="text-slate-800 bg-white">{crane}</option>)}
                                                </optgroup>
                                            ))}
                                        </select>
                                    </div>
                                </InputGroup>
                            </div>

                            <div className="md:col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-widest px-1 flex gap-2 items-center"><TruckIcon size={14}/> Hire Package Configuration</div>
                                <div className="grid grid-cols-3 gap-3">
                                    <Stepper label="Mob (Hrs)" value={formData.mobHours} onChange={(v) => updateHours('mobHours', v)} step={0.5} />
                                    <Stepper label="Demob (Hrs)" value={formData.demobHours} onChange={(v) => updateHours('demobHours', v)} step={0.5} />
                                    <Stepper label="Onsite (Hrs)" value={formData.siteHours} onChange={(v) => updateHours('siteHours', v)} step={0.5} />
                                </div>
                                <div className="text-xs text-slate-500 text-center font-mono">Total Min. Hours: <span className="font-bold text-slate-900">{totalMinHours}</span></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <InputGroup label="Normal Rate (€/hr)" icon={Euro}><TextInput type="number" name="hourlyRate" value={formData.hourlyRate} onChange={handleChange} /></InputGroup>
                                    <InputGroup label="Overtime Rate (€/hr)" icon={Clock}><TextInput type="number" name="overtimeRate" value={formData.overtimeRate} onChange={handleChange} /></InputGroup>
                                </div>
                            </div>

                            <div className="md:col-span-2 space-y-4">
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-widest px-1 flex justify-between items-center">
                                    <span>Additional Services</span>
                                    <label className="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" name="addVat" checked={formData.addVat} onChange={handleChange} className="sr-only peer" />
                                        <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-300 rounded-full peer peer-checked:bg-yellow-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                                        <span className="ml-2 text-[10px] font-bold text-slate-500">VAT (23%)</span>
                                    </label>
                                </div>
                                
                                {/* LIFT PLAN */}
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div className="flex flex-col md:flex-row md:items-center gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer min-w-[150px]">
                                            <input type="checkbox" name="liftPlanRequired" checked={formData.liftPlanRequired} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/>
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><FileCheck size={16}/> Lift Plan</span>
                                        </label>
                                        {formData.liftPlanRequired && (
                                            <div className="flex-1 flex gap-4 animate-fade-in items-center">
                                                <div className="relative flex-1"><span className="absolute left-3 top-2.5 text-slate-400 text-xs font-bold">€</span><input type="number" name="liftPlanCost" disabled={formData.liftPlanIncluded} value={formData.liftPlanCost} onChange={handleChange} className="w-full bg-white border border-slate-300 rounded-lg py-2 pl-7 pr-3 text-sm outline-none disabled:bg-slate-100"/></div>
                                                <label className="flex items-center gap-2 cursor-pointer whitespace-nowrap"><input type="checkbox" name="liftPlanIncluded" checked={formData.liftPlanIncluded} onChange={handleChange} className="w-4 h-4 accent-green-500 rounded"/><span className="text-xs font-bold text-slate-600">Included</span></label>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* LIFT SUPERVISOR (WAS AP) */}
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div className="flex flex-col md:flex-row md:items-center gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer min-w-[150px]">
                                            <input type="checkbox" name="apRequired" checked={formData.apRequired} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/>
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><Briefcase size={16}/> Lift Supervisor</span>
                                        </label>
                                        {formData.apRequired && (
                                            <div className="flex-1 flex flex-col md:flex-row gap-4 animate-fade-in md:items-center">
                                                <div className="flex items-center gap-2 w-full md:w-32"><span className="text-xs font-bold text-slate-500 w-8">Qty: {formData.apCount}</span><input type="range" name="apCount" min="1" max="5" value={formData.apCount} onChange={handleChange} className="flex-1"/></div>
                                                <div className="flex gap-4 items-center flex-1">
                                                    <div className="relative flex-1"><span className="absolute left-3 top-2.5 text-slate-400 text-xs font-bold">€</span><input type="number" name="apCost" disabled={formData.apIncluded} value={formData.apCost} onChange={handleChange} className="w-full bg-white border border-slate-300 rounded-lg py-2 pl-7 pr-3 text-sm outline-none disabled:bg-slate-100"/></div>
                                                    <label className="flex items-center gap-2 cursor-pointer whitespace-nowrap"><input type="checkbox" name="apIncluded" checked={formData.apIncluded} onChange={handleChange} className="w-4 h-4 accent-green-500 rounded"/><span className="text-xs font-bold text-slate-600">Included</span></label>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* BANKSMAN */}
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div className="flex flex-col md:flex-row md:items-center gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer min-w-[150px]">
                                            <input type="checkbox" name="banksmanRequired" checked={formData.banksmanRequired} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/>
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><Users size={16}/> Banksman</span>
                                        </label>
                                        {formData.banksmanRequired && (
                                            <div className="flex-1 flex flex-col md:flex-row gap-4 animate-fade-in md:items-center">
                                                <div className="flex items-center gap-2 w-full md:w-32"><span className="text-xs font-bold text-slate-500 w-8">Qty: {formData.banksmanCount}</span><input type="range" name="banksmanCount" min="1" max="5" value={formData.banksmanCount} onChange={handleChange} className="flex-1"/></div>
                                                <div className="flex gap-4 items-center flex-1">
                                                    <div className="relative flex-1"><span className="absolute left-3 top-2.5 text-slate-400 text-xs font-bold">€</span><input type="number" name="banksmanCost" disabled={formData.banksmanIncluded} value={formData.banksmanCost} onChange={handleChange} className="w-full bg-white border border-slate-300 rounded-lg py-2 pl-7 pr-3 text-sm outline-none disabled:bg-slate-100"/></div>
                                                    <label className="flex items-center gap-2 cursor-pointer whitespace-nowrap"><input type="checkbox" name="banksmanIncluded" checked={formData.banksmanIncluded} onChange={handleChange} className="w-4 h-4 accent-green-500 rounded"/><span className="text-xs font-bold text-slate-600">Included</span></label>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* BALLAST TRUCK */}
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div className="flex flex-col md:flex-row md:items-center gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer min-w-[150px]">
                                            <input type="checkbox" name="ballastRequired" checked={formData.ballastRequired} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/>
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><TruckIcon size={16}/> Ballast Truck</span>
                                        </label>
                                        {formData.ballastRequired && (
                                            <div className="flex-1 flex gap-4 animate-fade-in items-center">
                                                <div className="relative flex-1">
                                                    <span className="absolute left-3 top-2.5 text-slate-400 text-xs font-bold">€</span>
                                                    <input type="number" name="ballastCost" value={formData.ballastCost} onChange={handleChange} className="w-full bg-white border border-slate-300 rounded-lg py-2 pl-7 pr-3 text-sm outline-none"/>
                                                </div>
                                                <span className="text-xs font-bold text-slate-400 whitespace-nowrap">Each Way</span>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* OTHER ITEMS */}
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div className="flex flex-col md:flex-row md:items-center gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer min-w-[150px]">
                                            <input type="checkbox" name="otherItemsRequired" checked={formData.otherItemsRequired} onChange={handleChange} className="w-5 h-5 accent-yellow-500 rounded"/>
                                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><Box size={16}/> Other Items</span>
                                        </label>
                                        {formData.otherItemsRequired && (
                                            <div className="flex-1 flex gap-2 animate-fade-in items-center">
                                                <input type="text" name="otherItemsDesc" placeholder="Description" value={formData.otherItemsDesc} onChange={handleChange} className="flex-[2] bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm outline-none"/>
                                                <div className="relative flex-1">
                                                    <span className="absolute left-3 top-2.5 text-slate-400 text-xs font-bold">€</span>
                                                    <input type="number" name="otherItemsCost" placeholder="0.00" value={formData.otherItemsCost} onChange={handleChange} className="w-full bg-white border border-slate-300 rounded-lg py-2 pl-7 pr-3 text-sm outline-none"/>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div className="flex gap-4 overflow-x-auto py-2">
                             <div className="flex items-center gap-2 px-3 py-1.5 rounded bg-white border border-slate-200 whitespace-nowrap shadow-sm"><ShieldCheck size={12} className="text-brand-yellow" /><span className="text-[10px] font-bold text-slate-500">ISO 9001 Certified</span></div>
                             <div className="flex items-center gap-2 px-3 py-1.5 rounded bg-white border border-slate-200 whitespace-nowrap shadow-sm"><Map size={12} className="text-brand-yellow" /><span className="text-[10px] font-bold text-slate-500">Nationwide Coverage</span></div>
                        </div>
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-xl border-t border-slate-200 z-50">
                        <div className="max-w-3xl mx-auto flex flex-col gap-2">
                            {statusMsg && <div className="text-center text-[10px] font-bold text-blue-500 animate-pulse">{statusMsg}</div>}
                            <button onClick={handleGenerate} disabled={isGenerating || !formData.clientName} className="w-full bg-kavanagh-blue text-slate-900 font-bold text-sm py-4 rounded-xl shadow-lg hover:bg-[#33d6ff] active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                {isGenerating ? <span>Generating PDF...</span> : <><Share size={18} /> Generate Quote & Share</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><AppContent /></ErrorBoundary>);
    </script>
</body>
</html>
