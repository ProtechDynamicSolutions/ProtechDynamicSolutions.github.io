<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kavanagh Crane Hire - Quote Tool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Import Map for React modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-yellow': '#fecb00',
                        'brand-black': '#1a1a1a',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Clean Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f4f4f5; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #fecb00; }
        
        .white-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(228, 228, 231, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
        }

        body {
            background-color: #f8fafc;
            color: #1e293b;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            FileText, Share, Calendar, MapPin, User, Truck, Phone, 
            Clipboard, Euro, FileBadge, ShieldCheck, Map, HardHat, Clock, Mail, AlertTriangle
        } from 'lucide-react';
        
        // Safe imports for Firebase
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "firebase/auth";
        import { getFirestore, doc, getDoc, runTransaction } from "firebase/firestore";

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("React Error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-slate-50 p-8">
                            <div className="bg-white p-6 rounded-xl shadow-lg border border-red-100 max-w-md w-full text-center">
                                <div className="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4">
                                    <AlertTriangle className="text-red-500" />
                                </div>
                                <h2 className="text-lg font-bold text-slate-900 mb-2">Something went wrong</h2>
                                <p className="text-sm text-slate-500 mb-4 font-mono text-xs text-left bg-slate-50 p-3 rounded">
                                    {this.state.error && this.state.error.toString()}
                                </p>
                                <button onClick={() => window.location.reload()} className="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                    Reload App
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- FIREBASE INIT (SAFE) ---
        let auth = null;
        let db = null;
        let appId = 'default-app-id';
        let firebaseAvailable = false;

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                firebaseAvailable = true;
            } else {
                console.warn("Firebase config missing. Running in offline mode.");
            }
        } catch (e) {
            console.warn("Firebase init failed. Running in offline mode.", e);
        }

        const ADVISERS = [
            { name: "Seán O'Herlihy", initials: "SOH", phone: "083 470 0338" }
        ];

        const CRANE_LIST = [
            {
                category: "Spider & Self-Erecting Cranes",
                cranes: ["Maeda MC285C-3", "Liebherr MK140-5.1", "Spierings SK 1265 (6-Axle)"]
            },
            {
                category: "City & All Terrain Cranes",
                cranes: [
                    "Demag AC30 City (30t)", "Demag AC40-2L (40t)", "Demag AC40 City (40t)",
                    "Liebherr LTM 1040-2.1 (40t)", "Demag AC45 City (45t)", "Liebherr LTF 1045-4.1 (45t)",
                    "Liebherr LTC 1050-3.1 (50t)", "Demag AC50-1 (50t)", "Demag AC55 City (55t)",
                    "Liebherr LTF 1060-4.1 (60t)", "Grove GMK3060 (60t)", "Demag AC60-3L (60t)",
                    "Liebherr LTR 1060 (60t Crawler)", "Liebherr LTM 1060-3.1 (60t)", "Demag AC80-2 (80t)",
                    "Liebherr LTM 1090-4.1 (90t)", "Liebherr LTM 1090-4.2 (90t)", "Tadano ATF 90G-4 (90t)",
                    "Demag AC100-4L (100t)", "Grove GMK4100-4L (100t)", "Liebherr LTM 1100-5.2 (100t)",
                    "Tadano ATF 100G-4 (100t)", "Liebherr LTM 1110-5.1 (110t)", "Demag AC120-1 (120t)",
                    "Grove GMK5130-2 (130t)", "Liebherr LTM 1130-5.1 (130t)", "Liebherr LTM 1150-5.3 (150t)",
                    "Demag AC220-5 (220t)", "Liebherr LTM 1230-5.1 (230t)", "Liebherr LTM 1300-6.2 (300t)",
                    "Liebherr LTM 1300-6.3 (300t)", "Liebherr LTM 1450-8.1 (450t)", "Liebherr LTM 1500-8.1 (500t)",
                    "Liebherr LTM 1650-8.1 (700t)", "Liebherr LTM 1750-9.1 (800t)"
                ]
            }
        ];

        const InputGroup = ({ label, icon: Icon, children }) => (
            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm focus-within:ring-2 focus-within:ring-yellow-400 transition-all group hover:border-slate-300">
                <label className="flex items-center gap-2 text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest group-focus-within:text-yellow-600 transition-colors">
                    {Icon && <Icon size={12} />} {label}
                </label>
                {children}
            </div>
        );

        const TextInput = ({ ...props }) => (
            <input 
                {...props}
                className="w-full bg-transparent outline-none text-slate-800 font-semibold placeholder-slate-400 text-sm"
            />
        );

        function AppContent() {
            const [user, setUser] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [count, setCount] = useState(null);

            const [formData, setFormData] = useState({
                adviserName: ADVISERS[0].name,
                adviserInitials: ADVISERS[0].initials,
                clientName: '',
                clientEmail: '',
                date: new Date().toISOString().split('T')[0],
                craneType: 'Demag AC50-1 (50t)',
                price: '',
                minHours: '8',
                jobDetails: '',
                siteAddress: 'Cork',
                contactName: '',
                contactNumber: ''
            });

            const offlineRef = React.useMemo(() => Math.floor(Math.random() * 9000) + 1000, []);
            
            const quoteRef = count 
                ? `${formData.adviserInitials}-${count.toString().padStart(5, '0')}` 
                : `${formData.adviserInitials}-${offlineRef} (Offline)`;

            useEffect(() => {
                const initAuth = async () => {
                    if (!firebaseAvailable || !auth) return;
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.warn("Auth error (Running Offline):", err);
                    }
                };
                initAuth();

                if (firebaseAvailable && auth) {
                    const unsubscribe = onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (u) fetchCounter();
                    });
                    return () => unsubscribe();
                }
            }, []);

            const fetchCounter = async () => {
                if (!db) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'counters');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        setCount(docSnap.data().jobCount + 1);
                    } else {
                        setCount(1);
                    }
                } catch (err) {
                    console.warn("Error fetching counter (Offline mode):", err);
                    setCount(null); 
                }
            };

            const incrementCounter = async () => {
                if (!db || !user) return; // Don't try if offline
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'counters');
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        if (!sfDoc.exists()) {
                            transaction.set(docRef, { jobCount: 1 });
                        } else {
                            const newCount = sfDoc.data().jobCount + 1;
                            transaction.update(docRef, { jobCount: newCount });
                        }
                    });
                    fetchCounter();
                } catch (e) {
                    console.warn("Counter increment failed", e);
                }
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleAdviserChange = (e) => {
                const selected = ADVISERS.find(a => a.name === e.target.value);
                setFormData(prev => ({
                    ...prev,
                    adviserName: selected.name,
                    adviserInitials: selected.initials
                }));
            };

            const getBase64ImageFromURL = (url) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.setAttribute("crossOrigin", "anonymous");
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL("image/png"));
                    };
                    img.onerror = () => {
                        console.warn("Image load failed (CORS?):", url);
                        resolve(null);
                    };
                    img.src = url;
                });
            };

            const generatePDF = async () => {
                if (!window.jspdf) {
                    setStatusMsg("PDF Library not ready. Please wait.");
                    return;
                }
                setIsGenerating(true);
                setStatusMsg('Generating Quote...');

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Constants
                    const yellow = [254, 203, 0]; // Brand Yellow
                    const black = [26, 26, 26];   // Brand Black
                    const grey = [74, 74, 74];    // Text Grey
                    const lightGrey = [245, 245, 245];

                    // Use Raw GitHub User Content Links to avoid Blob/CORS issues
                    const headerBgUrl = "https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/KavCranes.jpg";
                    const craneUrl = "https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/ltm-1650-8.1.jpg";
                    const logo50Url = "https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/Kav50.png";
                    const kavLogoUrl = "https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/KavLogo.png";
                    const isoUrl = "https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/KavISO.png";

                    const [headerBg, craneImg, logo50, isoImg, kavLogo] = await Promise.all([
                        getBase64ImageFromURL(headerBgUrl),
                        getBase64ImageFromURL(craneUrl),
                        getBase64ImageFromURL(logo50Url),
                        getBase64ImageFromURL(isoUrl),
                        getBase64ImageFromURL(kavLogoUrl)
                    ]);

                    // Helper for Footer
                    const drawFooter = (pageNum) => {
                        const footerY = 265;
                        doc.setFillColor(...black);
                        doc.rect(0, footerY, 210, 32, 'F');
                        
                        doc.setTextColor(...yellow);
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(10);
                        doc.text("THE CERTIFICATION PROCESS", 20, footerY + 10);
                        
                        doc.setTextColor(200, 200, 200);
                        doc.setFont("helvetica", "normal");
                        doc.setFontSize(7);
                        const footerTxt = "We partnered with Amtivo (formerly Certification Europe) for their strong industry reputation and INAB-accreditation. Working with a consultant, we aligned our systems with ISO 9001, ISO 14001, and ISO 45001 standards.";
                        doc.text(doc.splitTextToSize(footerTxt, 110), 20, footerY + 16);

                        // ISO Logos
                        if (isoImg) {
                            // Scale down if needed, fit in approx 60x20 box
                            doc.addImage(isoImg, 'PNG', 135, footerY + 5, 60, 22);
                        }
                    };

                    // Helper for Sidebar - Contact
                    const drawSidebarContact = (sY, sideX) => {
                        doc.setTextColor(...black);
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(10);
                        doc.text("CONTACT US", sideX + 25, sY, { align: "center" });
                        sY += 8;
                        
                        // Contact Person
                        doc.setTextColor(...grey);
                        doc.setFontSize(9);
                        doc.setFont("helvetica", "bold");
                        doc.text("Contact Seán O'Herlihy", sideX + 25, sY, { align: "center" });
                        sY += 8;

                        doc.setFont("helvetica", "bold");
                        doc.text("Mobile:", sideX + 25, sY, { align: "center" });
                        doc.setFont("helvetica", "normal");
                        sY += 5;
                        doc.text(ADVISERS[0].phone, sideX + 25, sY, { align: "center" });
                        sY += 8;
                        doc.setFont("helvetica", "bold");
                        doc.text("Email:", sideX + 25, sY, { align: "center" });
                        doc.setFont("helvetica", "normal");
                        sY += 5;
                        doc.text("sean@kavanaghcranehire.ie", sideX + 25, sY, { align: "center" });
                        return sY;
                    }

                    // ================= PAGE 1: PROPOSAL & PHOTOS =================
                    
                    // --- HERO HEADER ---
                    // Changed Height from 60 to 50 to reduce stretching
                    if (headerBg) {
                        doc.addImage(headerBg, 'JPEG', 0, 0, 210, 50);
                    }
                    
                    // Yellow Overlay with transparency
                    doc.setGState(new doc.GState({ opacity: 0.9 }));
                    doc.setFillColor(...yellow);
                    doc.rect(0, 0, 210, 50, 'F');
                    doc.setGState(new doc.GState({ opacity: 1.0 }));

                    // Header Logo
                    if (kavLogo) {
                        // Positioned slightly higher due to shorter header
                        doc.addImage(kavLogo, 'PNG', 15, 10, 60, 20); 
                    } else {
                        // Fallback Text - Beefed up
                        doc.setTextColor(...black);
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(32); // Beefed up from 28
                        doc.text("KAVANAGH", 15, 25);
                        doc.setFontSize(12);
                        doc.text("CRANE HIRE LTD.", 15, 32);
                    }

                    // Quote Reference Box
                    const cleanRef = count ? quoteRef : `${formData.adviserInitials}-${offlineRef}`;

                    // Match Page 2 Style (Just text aligned right on header)
                    doc.setTextColor(...black); 
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    // Align roughly with Page 2 position
                    doc.text(`Quote Ref: ${cleanRef}`, 190, 25, { align: "right" });

                    // Slogan Bar - Moved up
                    doc.setFillColor(...black);
                    doc.rect(0, 50, 210, 10, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "italic");
                    doc.text("Elevating Excellence Since 1973 - Where Commitment Meets Capability!", 105, 56, { align: "center" });

                    // --- PROPOSAL TEXT ---
                    // Increased margins from 15 to 20 for print safety
                    let y = 75;
                    const mainX = 20; 
                    const fullW = 170; // Adjusted width for margins

                    doc.setTextColor(...black);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(14);
                    doc.text("PROPOSAL", mainX, y);
                    doc.setDrawColor(...yellow);
                    doc.setLineWidth(1);
                    doc.line(mainX, y+2, mainX+30, y+2);
                    y += 10;

                    doc.setTextColor(...grey);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    
                    // Combined Text
                    const para1 = `Thank you for giving Kavanagh Crane Hire the opportunity to submit this proposal. Since our formation in 1973 we have gained a wealth of experience and knowledge within the industry. We are committed to maintaining the most modern and advanced equipment there is.`;
                    
                    const para2 = `Proudly supplying Crane Hire in Dublin & Cork with expert crane hire and specialized heavy lift engineering solutions across a range of industries. Backed by years of experience and investment, our strategically located depots ensure fast, efficient, and reliable service for projects of all sizes.`;
                    
                    const para3 = `As a family-run business, we prioritise safety, dependability, and exceptional customer service from consultation to project completion. Our diverse crane fleet—ranging from compact city cranes to powerful 700-tonne all-terrain cranes—is meticulously maintained and operated by certified professionals, ready to handle even the most complex lifting equipment challenges.`;

                    const fullIntro = `${para1}\n\n${para2}\n\n${para3}`;

                    const introLines = doc.splitTextToSize(fullIntro, fullW);
                    doc.text(introLines, mainX, y);
                    
                    // Advance Y based on text lines
                    y += (introLines.length * 5) + 10;

                    // --- LARGE HERO CRANE PHOTO ---
                    // Check if we need a new page or just squeeze it
                    // Max Y for page 1 content (leaving room for footer at 265) is approx 260.
                    // If y > 180, photo might get tight.
                    
                    if (craneImg) {
                        const imgW = 170;
                        const imgH = 80; 
                        
                        // Center image
                        const xPos = (210 - imgW) / 2;
                        
                        // Ensure we don't overlap footer
                        if (y + imgH > 260) {
                            // If too tight, add page or shrink image? 
                            // Request said "lower picture", so it must flow after text.
                            // If text is very long, image might go to page 2?
                            // Let's try to fit it.
                            doc.addImage(craneImg, 'JPEG', xPos, y, imgW, imgH);
                        } else {
                            doc.addImage(craneImg, 'JPEG', xPos, y, imgW, imgH);
                        }
                    }

                    // --- SAFETY FOOTER (PAGE 1) ---
                    drawFooter(1);

                    // ================= PAGE 2: DETAILS =================
                    doc.addPage();

                    // Simple Header for Page 2
                    doc.setFillColor(...yellow);
                    doc.rect(0, 0, 210, 25, 'F'); 
                    
                    // Header Logo Page 2
                    if (kavLogo) {
                        doc.addImage(kavLogo, 'PNG', 20, 2, 45, 15);
                    }
                    
                    doc.setTextColor(...black);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text(`Quote Ref: ${cleanRef}`, 190, 15, { align: "right" });
                    
                    y = 40; 
                    const sideX = 140; // Sidebar start
                    const contentW = 110;

                    // --- LEFT COL: SPEC ---
                    doc.setFontSize(14);
                    doc.text("JOB SPECIFICATION", mainX, y);
                    y += 6;

                    // Increase box height to accommodate pricing
                    const boxHeight = 90; // Slightly taller for padding
                    doc.setFillColor(...lightGrey);
                    doc.setDrawColor(...yellow);
                    doc.setLineWidth(1.5); 
                    doc.rect(mainX, y, contentW, boxHeight, 'F'); 
                    doc.line(mainX, y, mainX, y+boxHeight); 

                    // Grid Data
                    let gridY = y + 10;
                    const drawSpecItem = (label, val, xOffset, yOffset) => {
                        doc.setFontSize(7);
                        doc.setTextColor(120, 120, 120);
                        doc.setFont("helvetica", "bold");
                        doc.text(label.toUpperCase(), mainX + 5 + xOffset, yOffset);
                        doc.setFontSize(10);
                        doc.setTextColor(...black);
                        doc.setFont("helvetica", "normal");
                        doc.text(val || "-", mainX + 5 + xOffset, yOffset + 5);
                    };

                    const hasPricing = formData.price && formData.minHours;
                    const totalVal = hasPricing ? (parseFloat(formData.price) * parseFloat(formData.minHours)).toFixed(2) : "POA";

                    drawSpecItem("Customer Name", formData.clientName, 0, gridY);
                    gridY += 12;
                    drawSpecItem("Customer Email", formData.clientEmail, 0, gridY);
                    gridY += 12;
                    drawSpecItem("Crane Type", formData.craneType, 0, gridY);
                    gridY += 12;
                    drawSpecItem("Site Address", formData.siteAddress, 0, gridY);
                    
                    // Divider Line inside Box
                    gridY += 12;
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.line(mainX + 5, gridY - 2, mainX + contentW - 5, gridY - 2);

                    // Pricing INSIDE grid now
                    gridY += 6; 
                    drawSpecItem("Hourly Rate", `EUR ${formData.price || '0.00'}`, 0, gridY);
                    drawSpecItem("Min. Hours", `${formData.minHours || '8'} Hrs`, 40, gridY);
                    
                    gridY += 15; // Extra padding for Total
                    // Total with highlight
                    doc.setFillColor(254, 252, 232); // Light yellow bg for total
                    doc.rect(mainX + 4, gridY - 3, 60, 12, 'F');
                    doc.setTextColor(220, 0, 0); 
                    drawSpecItem("Total (Ex VAT)", `EUR ${totalVal}`, 0, gridY + 1); // Added +1 to nudge text down in box

                    y += boxHeight + 10;

                    // --- LEFT COL: T&CS ---
                    doc.setTextColor(...black);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(12);
                    doc.text("TERMS & CONDITIONS", mainX, y);
                    y += 6;

                    doc.setTextColor(...grey);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(8);
                    
                    const terms = [
                        "1. All site inductions and familiarisation of site by Employing Contractor/Hirer.",
                        "2. Crane standing areas by Employing Contractor/Hirer. Kavanagh Crane Hire cannot accept responsibility for any delays incurred in setting up crane if ground conditions/access roads are not favourable.",
                        "3. Permits & Traffic management are the responsibility of the Hirer unless otherwise agreed.",
                        "4. All quoted rates are subject to 23% VAT.",
                        "5. Crane sizes and positions are based on information given. We recommend a site survey to confirm.",
                        "6. Hirer is responsible for ground conditions and must sign off 'Section 7' of the lift plan.",
                        "7. Standard Slings/Chains supplied. Specialist tackle available on request.",
                        "8. Winded off hours charged at 75% of min hire rate."
                    ];

                    terms.forEach((term, index) => {
                         const lines = doc.splitTextToSize(term, contentW);
                         doc.text(lines, mainX + 5, y);
                         // Bullet
                         doc.setFont("helvetica", "bold");
                         doc.text((index+1) + ".", mainX, y);
                         doc.setFont("helvetica", "normal");
                         y += (lines.length * 4) + 2;
                    });


                    // --- RIGHT COL: SIDEBAR ---
                    let sY = 40;

                    // 50 Years Logo
                    if (logo50) {
                        doc.addImage(logo50, 'PNG', sideX, sY, 50, 40);
                        sY += 50;
                    }

                    // Divider
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.line(sideX, sY, sideX+50, sY);
                    sY += 10;

                    // Locations
                    doc.setTextColor(...black);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text("LOCATIONS", sideX + 25, sY, { align: "center" });
                    sY += 8;
                    doc.setTextColor(...grey);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    const locs = ["Dublin", "Cork", "Wexford", "Waterford", "Carlow"];
                    locs.forEach(l => {
                        doc.text(l, sideX + 25, sY, { align: "center" });
                        sY += 5;
                    });
                    
                    sY += 10;
                    doc.setDrawColor(200, 200, 200);
                    doc.line(sideX, sY, sideX+50, sY);
                    sY += 10;

                    // Contact
                    drawSidebarContact(sY, sideX);

                    // --- FOOTER PAGE 2 ---
                    drawFooter(2);

                    // --- SAVE ---
                    const blob = doc.output('blob');
                    const file = new File([blob], `${cleanRef}_${formData.clientName}.pdf`, { type: 'application/pdf' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: `Quote ${cleanRef}`,
                            text: `Please find attached quote ${cleanRef} from ${formData.adviserName}.`
                        });
                        setStatusMsg('Quote Shared');
                    } else {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = file.name;
                        a.click();
                        setStatusMsg('Quote Downloaded');
                    }

                    if (firebaseAvailable) {
                        await incrementCounter();
                    }

                } catch (err) {
                    console.error(err);
                    setStatusMsg(`Error: ${err.message}`);
                }
                
                setTimeout(() => { setIsGenerating(false); setStatusMsg(''); }, 3000);
            };

            return (
                <div className="min-h-screen relative flex flex-col pb-24 bg-slate-50">
                    <nav className="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
                        <div className="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
                             <div className="flex items-center gap-3">
                                <img 
                                    src="https://raw.githubusercontent.com/ProtechDynamicSolutions/ProtechDynamicSolutions.github.io/main/Kavanagh/KavLogo.png" 
                                    alt="Kavanagh" 
                                    className="h-10 w-auto object-contain"
                                    onError={(e) => e.target.style.display = 'none'}
                                />
                                <div className="hidden sm:block">
                                    <h1 className="text-sm font-bold text-slate-900 tracking-tight">KAVANAGH</h1>
                                </div>
                             </div>
                             
                             <div className="px-3 py-1 bg-yellow-100 border border-yellow-200 rounded-full flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                <span className="text-xs font-mono font-bold text-yellow-700 tracking-wide">{quoteRef}</span>
                             </div>
                        </div>
                    </nav>

                    <main className="flex-grow w-full max-w-3xl mx-auto px-4 py-6 relative z-10 space-y-6">
                        <div className="white-panel p-6 rounded-2xl relative overflow-hidden">
                             <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-400/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                             <h2 className="text-xl font-bold text-slate-800 mb-1 flex items-center gap-2">
                                <FileText className="text-brand-yellow" size={24} /> 
                                Quote Generator
                             </h2>
                             <p className="text-xs text-slate-500">
                                Create industrial-standard proposals.
                                {!firebaseAvailable && <span className="text-amber-500 font-bold ml-1"> (Offline Mode)</span>}
                             </p>
                        </div>

                        <div className="space-y-4 animate-fade-in grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2">
                                <InputGroup label="Crane Adviser" icon={HardHat}>
                                    <div className="relative">
                                        <select 
                                            name="adviser"
                                            value={formData.adviserName}
                                            onChange={handleAdviserChange}
                                            className="w-full bg-transparent outline-none text-slate-900 font-bold appearance-none text-sm cursor-pointer"
                                        >
                                            {ADVISERS.map(adv => (
                                                <option key={adv.initials} value={adv.name}>{adv.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </InputGroup>
                            </div>

                            <InputGroup label="Date" icon={Calendar}>
                                <TextInput type="date" name="date" value={formData.date} onChange={handleChange} />
                            </InputGroup>
                            
                            <InputGroup label="Ref Preview" icon={FileBadge}>
                                <div className="text-sm font-mono font-bold text-yellow-600 pt-1.5 truncate">{quoteRef}</div>
                            </InputGroup>

                            <InputGroup label="Client Name" icon={User}>
                                <TextInput name="clientName" placeholder="Company or Contact Name" value={formData.clientName} onChange={handleChange} />
                            </InputGroup>

                             <InputGroup label="Client Email" icon={Mail}>
                                <TextInput type="email" name="clientEmail" placeholder="email@example.com" value={formData.clientEmail} onChange={handleChange} />
                            </InputGroup>

                            <div className="md:col-span-2">
                                <InputGroup label="Site Address" icon={MapPin}>
                                    <TextInput name="siteAddress" value={formData.siteAddress} onChange={handleChange} />
                                </InputGroup>
                            </div>

                            <div className="md:col-span-2">
                                <InputGroup label="Crane Model" icon={Truck}>
                                    <div className="relative">
                                        <select 
                                            name="craneType"
                                            value={formData.craneType}
                                            onChange={handleChange}
                                            className="w-full bg-transparent outline-none text-slate-800 font-semibold appearance-none text-sm cursor-pointer"
                                        >
                                            {CRANE_LIST.map((group) => (
                                                <optgroup key={group.category} label={group.category} className="text-yellow-600 bg-white">
                                                    {group.cranes.map((crane) => (
                                                        <option key={crane} value={crane} className="text-slate-800 bg-white">{crane}</option>
                                                    ))}
                                                </optgroup>
                                            ))}
                                        </select>
                                    </div>
                                </InputGroup>
                            </div>

                            <InputGroup label="Hourly Rate (Ex VAT)" icon={Euro}>
                                <TextInput type="number" name="price" placeholder="0.00" value={formData.price} onChange={handleChange} />
                            </InputGroup>
                            
                            <InputGroup label="Min. Hire Hours" icon={Clock}>
                                <TextInput type="number" name="minHours" placeholder="8" value={formData.minHours} onChange={handleChange} />
                            </InputGroup>
                        </div>

                        <div className="flex gap-4 overflow-x-auto py-2">
                             <div className="flex items-center gap-2 px-3 py-1.5 rounded bg-white border border-slate-200 whitespace-nowrap shadow-sm">
                                <ShieldCheck size={12} className="text-brand-yellow" />
                                <span className="text-[10px] font-bold text-slate-500">ISO 9001 Certified</span>
                             </div>
                             <div className="flex items-center gap-2 px-3 py-1.5 rounded bg-white border border-slate-200 whitespace-nowrap shadow-sm">
                                <Map size={12} className="text-brand-yellow" />
                                <span className="text-[10px] font-bold text-slate-500">Nationwide Coverage</span>
                             </div>
                        </div>

                    </main>

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-xl border-t border-slate-200 z-50">
                        <div className="max-w-3xl mx-auto flex flex-col gap-2">
                            {statusMsg && (
                                <div className="text-center text-[10px] font-bold text-blue-500 animate-pulse">
                                    {statusMsg}
                                </div>
                            )}
                            <button 
                                onClick={generatePDF}
                                disabled={isGenerating || !formData.clientName}
                                className="w-full bg-brand-black text-white font-bold text-sm py-4 rounded-xl shadow-lg hover:bg-slate-800 hover:scale-[1.01] active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            >
                                {isGenerating ? (
                                    <span>Processing...</span>
                                ) : (
                                    <>
                                        <Share size={18} /> Generate & Share Quote
                                    </>
                                )}
                            </button>
                        </div>
                    </div>

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <AppContent />
            </ErrorBoundary>
        );
    </script>
</body>
</html>


