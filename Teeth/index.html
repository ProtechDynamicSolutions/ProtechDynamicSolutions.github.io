<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyblade Tooth Battle Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global bridge for Babel script
        window.FirebaseLib = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection };
    </script>

    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-fast { animation: spin 0.2s linear infinite; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        
        @keyframes launchUp {
            0% { transform: translateY(100vh) scale(0.5); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: translateY(-20vh) scale(1.5); opacity: 0; }
        }
        .animate-launch-up {
            animation: launchUp 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        body {
            background-color: #0f172a;
            color: #f8fafc;
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        #loading-arena {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #0f172a;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>
    <div id="loading-arena">
        <div style="width: 50px; height: 50px; border: 4px solid #3b82f6; border-top-color: transparent; border-radius: 50%;" class="animate-spin-fast"></div>
        <p style="margin-top: 20px; font-weight: 900; color: #60a5fa; text-transform: uppercase; letter-spacing: 0.1em; font-size: 12px;">Initialising Stadium...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const StarIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>);
        const TrophyIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>);
        const ZapIcon = ({ className, fill = "none" }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>);
        const XIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>);
        const EditIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>);
        const DownloadIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>);
        const CloudIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19a5.5 5.5 0 0 0 5.5-5.5c0-3.04-2.46-5.5-5.5-5.5-.32 0-.64.03-.96.08a8 8 0 1 0-14.54 4.04"/><path d="M12 12v9"/><path d="m15 18-3 3-3-3"/></svg>);
        const DiscIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>);

        // --- Beyblade Graphics ---
        const BlueDiamondIcon = ({ className, spinning }) => (
            <svg viewBox="0 0 100 100" className={`${className} ${spinning ? 'animate-spin-fast' : ''}`}>
                <defs>
                    <linearGradient id="silverGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#e5e7eb" /><stop offset="50%" stopColor="#9ca3af" /><stop offset="100%" stopColor="#d1d5db" /></linearGradient>
                    <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#fcd34d" /><stop offset="100%" stopColor="#d97706" /></linearGradient>
                </defs>
                <path d="M50 2 L65 15 L85 10 L80 30 L98 50 L80 70 L85 90 L65 85 L50 98 L35 85 L15 90 L20 70 L2 50 L20 30 L15 10 L35 15 Z" fill="#0ea5e9" stroke="#0284c7" strokeWidth="2" opacity="0.9"/>
                <circle cx="50" cy="50" r="32" fill="#dc2626" stroke="#991b1b" strokeWidth="2" />
                <path d="M20 35 L35 35 L30 65 L20 65 Z" fill="url(#silverGrad)" stroke="#4b5563" strokeWidth="1" />
                <path d="M80 35 L65 35 L70 65 L80 65 Z" fill="url(#silverGrad)" stroke="#4b5563" strokeWidth="1" />
                <path d="M50 25 L65 40 L50 75 L35 40 Z" fill="url(#goldGrad)" stroke="#b45309" strokeWidth="1" />
                <circle cx="50" cy="45" r="6" fill="#1e3a8a" stroke="#60a5fa" strokeWidth="2" />
            </svg>
        );

        const BellFireIcon = ({ className, spinning }) => (
            <svg viewBox="0 0 100 100" className={`${className} ${spinning ? 'animate-spin-fast' : ''}`}>
                <path d="M50 5 L80 20 L95 50 L80 80 L50 95 L20 80 L5 50 L20 20 Z" fill="#1c1917" stroke="#dc2626" strokeWidth="2" />
                <path d="M50 15 L70 30 L50 50 L30 30 Z" fill="#fbbf24" />
                <path d="M50 85 L70 70 L50 50 L30 70 Z" fill="#fbbf24" />
                <path d="M85 50 L70 70 L50 50 L70 30 Z" fill="#fbbf24" />
                <path d="M15 50 L30 70 L50 50 L30 30 Z" fill="#fbbf24" />
                <circle cx="50" cy="50" r="15" fill="#ef4444" stroke="#7f1d1d" strokeWidth="2" />
                <path d="M45 45 L55 55 M55 45 L45 55" stroke="black" strokeWidth="3" />
            </svg>
        );

        const USERS = {
            MAX: { id: 'max', name: 'Max', color: 'bg-blue-600', text: 'text-blue-100', Graphic: BlueDiamondIcon, beyName: 'Blue Diamond' },
            ARI: { id: 'ari', name: 'Ari', color: 'bg-red-600', text: 'text-red-100', Graphic: BellFireIcon, beyName: 'Bell Fire' }
        };

        const formatDateKey = (date) => date.toISOString().split('T')[0];

        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [logs, setLogs] = useState({});
            const [currentUser, setCurrentUser] = useState(null);
            const [adminMode, setAdminMode] = useState(false);
            const [celebration, setCelebration] = useState(null);
            const [showThursdayPopup, setShowThursdayPopup] = useState(false);
            const [showReward, setShowReward] = useState(false);
            const [isSyncing, setIsSyncing] = useState(true);

            // --- 1. BOOT SEQUENCE WITH PROVIDED CONFIG ---
            useEffect(() => {
                const boot = async () => {
                    if (!window.FirebaseLib) return;
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore } = window.FirebaseLib;
                    
                    const config = {
                        apiKey: "AIzaSyDdFKVuP0dXbH4XCw_hLqlIvluJfutYnUQ",
                        authDomain: "teeth2-3f73e.firebaseapp.com",
                        projectId: "teeth2-3f73e",
                        storageBucket: "teeth2-3f73e.firebasestorage.app",
                        messagingSenderId: "245367626619",
                        appId: "1:245367626619:web:c496a86089539bdb5fbbde"
                    };

                    try {
                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);

                        // Silent anonymous login
                        await signInAnonymously(auth);

                        onAuthStateChanged(auth, u => {
                            if (u) {
                                setUser(u);
                                const loader = document.getElementById('loading-arena');
                                if (loader) {
                                    loader.style.opacity = '0';
                                    setTimeout(() => loader.style.display = 'none', 500);
                                }
                            }
                        });
                    } catch (e) {
                        console.error("Battle Arena Ignition Failed", e);
                    }
                };
                boot();
            }, []);

            // --- 2. CLOUD SYNC ---
            useEffect(() => {
                if (!db || !user) return;
                const { doc, onSnapshot } = window.FirebaseLib;
                const appId = 'teeth2-3f73e';
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'battle_logs');

                const unsub = onSnapshot(docRef, snap => {
                    if (snap.exists()) setLogs(snap.data());
                    setIsSyncing(false);
                }, (err) => {
                    console.error("Cloud Link Interrupted", err);
                    setIsSyncing(false);
                });
                return () => unsub();
            }, [db, user]);

            const saveLog = async (updated) => {
                if (!db || !user) return;
                const { doc, setDoc } = window.FirebaseLib;
                const appId = 'teeth2-3f73e';
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'battle_logs'), updated, { merge: true });
                } catch (e) { console.error(e); }
            };

            const toggleBrush = (userId, dateObj, slot) => {
                const key = `${userId}-${formatDateKey(dateObj)}-${slot}`;
                const checked = !logs[key];
                const updated = { ...logs, [key]: checked };
                setLogs(updated);
                saveLog(updated);

                if (checked) {
                    const now = new Date();
                    const isThu = now.getDay() === 4 && now.getHours() >= 17;
                    setCelebration(isThu ? 'thursday' : 'standard');
                    if (isThu) setTimeout(() => setShowThursdayPopup(true), 1500);
                    setTimeout(() => setCelebration(null), 3000);
                }
            };

            const streak = useMemo(() => {
                if (!currentUser) return 0;
                let c = 0;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const k = formatDateKey(d);
                    if (logs[`${currentUser.id}-${k}-am`] || logs[`${currentUser.id}-${k}-pm`]) c++;
                }
                return c;
            }, [currentUser, logs]);

            if (!user) return null;

            return (
                <div className="min-h-screen relative overflow-x-hidden p-4 md:p-8 selection:bg-blue-500">
                    <div className="fixed inset-0 opacity-10 pointer-events-none" style={{backgroundImage: 'linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px)', backgroundSize: '40px 40px'}}></div>
                    
                    {celebration && (
                        <div className="fixed inset-0 z-50 pointer-events-none overflow-hidden">
                            {Array.from({ length: 25 }).map((_, i) => (
                                <div key={i} className="absolute bottom-0 animate-launch-up" style={{left: `${Math.random() * 100}%`, animationDuration: `${1 + Math.random() * 2}s`, opacity: 0}}>
                                    {i % 3 === 0 ? <ZapIcon className="w-8 h-8 text-yellow-300" fill="currentColor" /> : <div className="text-2xl">ü¶∑</div>}
                                </div>
                            ))}
                        </div>
                    )}

                    {showThursdayPopup && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
                            <div className="bg-gradient-to-br from-indigo-900 to-purple-900 rounded-3xl p-8 text-center border-4 border-yellow-400 shadow-2xl relative max-w-sm">
                                <h2 className="text-3xl font-black text-yellow-300 mb-2 uppercase italic">Hyper Flux!</h2>
                                <div className="text-8xl mb-4 animate-pulse">‚ö°</div>
                                <p className="text-lg font-bold text-white mb-6 uppercase tracking-tighter">Tomorrow is Friday!<br/>Ready for the reward?</p>
                                <button onClick={() => setShowThursdayPopup(false)} className="bg-yellow-500 text-black font-black py-3 px-8 skew-x-[-10deg]">LET IT RIP!</button>
                            </div>
                        </div>
                    )}

                    {showReward && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
                            <div className="bg-slate-800 rounded-2xl p-8 text-center border-y-8 border-yellow-500 shadow-2xl max-w-sm">
                                <h2 className="text-5xl font-black text-white mb-4 italic">BURST FINISH!</h2>
                                <div className="text-8xl my-8 animate-bounce">üèÜüç´</div>
                                <button onClick={() => setShowReward(false)} className="w-full bg-red-600 text-white font-black py-4 rounded-xl text-2xl border-b-4 border-red-800">CLAIM TROPHY</button>
                            </div>
                        </div>
                    )}

                    <header className="text-center mb-10">
                        <div className="flex justify-center mb-2">
                             {isSyncing ? <span className="text-[10px] text-yellow-500 animate-pulse uppercase font-mono tracking-widest">Linking Stadium...</span> : <div className="flex items-center gap-1 text-[10px] text-green-500 uppercase font-mono tracking-widest"><CloudIcon className="w-3 h-3" /> Stadium Linked</div>}
                        </div>
                        <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-blue-400 to-white italic uppercase tracking-tighter transform -skew-x-6">BEYBLADE BURST</h1>
                        <h2 className="text-xl font-bold text-red-500 uppercase tracking-[0.4em] mt-2">Tooth Battle</h2>
                    </header>

                    {!currentUser ? (
                        <div className="flex flex-wrap justify-center gap-10 mt-12 animate-in fade-in duration-500">
                            {Object.values(USERS).map(user => (
                                <button key={user.id} onClick={() => setCurrentUser(user)} className={`relative w-44 h-44 rounded-full ${user.color} border-4 border-white/20 hover:scale-110 active:scale-95 transition-all shadow-2xl p-2`}>
                                    <user.Graphic className="w-full h-full" spinning={false} />
                                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 px-3 py-1 rounded text-[10px] font-bold uppercase text-white border border-white/10">{user.beyName}</div>
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="max-w-2xl mx-auto">
                            <div className="flex items-center justify-between mb-8 bg-slate-900/80 p-4 rounded-xl border border-white/10 shadow-lg">
                                <button onClick={() => setCurrentUser(null)} className="text-gray-400 font-bold uppercase text-[10px] tracking-widest hover:text-white transition-colors">‚Üê Eject</button>
                                <div className="flex items-center gap-4 text-right">
                                    <div>
                                        <div className={`font-black text-2xl uppercase italic ${currentUser.text}`}>{currentUser.name}</div>
                                        <div className="text-[10px] text-gray-500 font-mono uppercase">Tournament Streak: {streak} Days</div>
                                    </div>
                                    <div className="w-12 h-12 bg-slate-800 rounded-full p-1 border-2 border-white/10">
                                        <currentUser.Graphic className="w-full h-full" />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-gray-800/50 rounded-[3rem] p-8 border-4 border-gray-700 shadow-2xl relative mb-8">
                                <div className="grid grid-cols-2 gap-6">
                                    {['am', 'pm'].map(slot => {
                                        const done = logs[`${currentUser.id}-${formatDateKey(new Date())}-${slot}`];
                                        return (
                                            <button key={slot} onClick={() => toggleBrush(currentUser.id, new Date(), slot)} className={`relative h-44 md:h-48 rounded-full border-8 transition-all flex flex-col items-center justify-center overflow-hidden active:scale-95 ${done ? 'bg-gradient-to-br from-yellow-400 to-red-500 border-yellow-200' : 'bg-gray-700 border-gray-600'}`}>
                                                {done ? (
                                                    <div className="flex flex-col items-center">
                                                        <currentUser.Graphic className="w-24 h-24 mb-2" spinning={true} />
                                                        <span className="font-black text-white uppercase italic tracking-tighter text-xl">BURST!</span>
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-col items-center text-gray-500">
                                                        <span className="font-black uppercase text-[10px] tracking-widest mb-2">{slot} Launch</span>
                                                        <DiscIcon className="w-10 h-10" />
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="bg-black/40 rounded-xl p-6 border border-white/10">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-[10px] font-bold uppercase tracking-widest text-gray-400 flex items-center gap-2"><TrophyIcon className="w-4 h-4 text-yellow-500"/> Tournament Record</h3>
                                    {(new Date().getDay() === 5 && streak >= 6) && <button onClick={() => setShowReward(true)} className="bg-yellow-500 text-black px-4 py-1 font-black text-[10px] uppercase animate-bounce shadow-lg skew-x-[-10deg]">Claim Prize!</button>}
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {Array.from({ length: 7 }).map((_, i) => {
                                        const d = new Date(); d.setDate(d.getDate() - (6 - i));
                                        const k = formatDateKey(d);
                                        const comp = logs[`${currentUser.id}-${k}-am`] && logs[`${currentUser.id}-${k}-pm`];
                                        return (
                                            <div key={i} className="flex flex-col items-center gap-1">
                                                <span className="text-[8px] uppercase font-bold text-gray-600">{d.toLocaleDateString('en-GB', { weekday: 'narrow' })}</span>
                                                <div onClick={() => adminMode && toggleBrush(currentUser.id, d, 'am')} className={`w-full aspect-square rounded border ${comp ? 'bg-blue-600/50 border-blue-400 shadow-[0_0_8px_rgba(59,130,246,0.5)]' : 'bg-black/30 border-white/5'} flex items-center justify-center overflow-hidden`}>
                                                    {comp && <currentUser.Graphic className="w-full h-full p-0.5" spinning={true} />}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="fixed bottom-0 left-0 w-full p-4 flex justify-center pointer-events-none z-50">
                        <div className={`pointer-events-auto flex items-center gap-4 px-6 py-2 transition-all backdrop-blur-md ${adminMode ? 'bg-red-600/90 text-white shadow-2xl' : 'bg-black/40 text-gray-500 translate-y-1/2 hover:translate-y-0'}`}>
                            {adminMode && (
                                <button onClick={() => {
                                    let csv = "Date,Blader,Time Slot,Result\n";
                                    Object.keys(logs).sort().forEach(k => { if (logs[k]) { const [u, d, s] = k.split('-'); csv += `${d},${USERS[u.toUpperCase()].name},${s.toUpperCase()},Burst\n`; } });
                                    const l = document.createElement("a"); l.href = encodeURI("data:text/csv;charset=utf-8," + csv); l.download = "battle_logs.csv"; l.click();
                                }} className="flex items-center gap-2 border-r border-red-400 pr-4 hover:text-yellow-300 uppercase text-[9px] font-black tracking-widest">
                                    <DownloadIcon className="w-3 h-3" /> Export
                                </button>
                            )}
                            <button onClick={() => setAdminMode(!adminMode)} className="flex items-center gap-2 text-[9px] font-black uppercase tracking-widest">
                                {adminMode ? <XIcon className="w-3 h-3" /> : <EditIcon className="w-3 h-3" />}
                                {adminMode ? 'Exit Referee' : 'WBBA Referee'}
                            </button>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

